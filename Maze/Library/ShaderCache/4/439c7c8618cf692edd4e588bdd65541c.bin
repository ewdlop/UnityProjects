using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Security;
using System.Security.Permissions;
using Microsoft.Win32;

namespace System.Net
{
    // This class behaves the same as WinHttpWebProxyFinder. The only difference is that in cases where
    // the script location has a scheme != HTTP, it falls back to NetWebProxyFinder which supports
    // also other schemes like FILE and FTP.
    // The mid-term goal for WinHttp is to support at least FILE scheme since it was already requested
    // by customers. The long term goal for System.Net is to use WinHttp only and remove this class
    // as well as NetWebProxyFinder.
    internal sealed class HybridWebProxyFinder : IWebProxyFinder
    {
        private const string allowFallbackKey = @"SOFTWARE\Microsoft\.NETFramework";
        private const string allowFallbackKeyPath = @"HKEY_LOCAL_MACHINE\" + allowFallbackKey;
        private const string allowFallbackValueName = "LegacyWPADSupport";

        private static bool allowFallback;

        private NetWebProxyFinder netFinder;
        private WinHttpWebProxyFinder winHttpFinder;
        private BaseWebProxyFinder currentFinder;
        private AutoWebProxyScriptEngine engine;

        static HybridWebProxyFinder()
        {
            InitializeFallbackSettings();
        }

        public HybridWebProxyFinder(AutoWebProxyScriptEngine engine)
        {
            this.engine = engine;            
            this.winHttpFinder = new WinHttpWebProxyFinder(engine);
            this.currentFinder = winHttpFinder;
        }

        public bool IsValid
        {
            get { return currentFinder.IsValid; }
        }

        public bool GetProxies(Uri destination, out IList<string> proxyList)
        {
            if (currentFinder.GetProxies(destination, out proxyList))
            {
                return true;
            }

            if (allowFallback && currentFinder.IsUnrecognizedScheme && (currentFinder == winHttpFinder))
            {
                // If WinHttpWebProxyFinder failed because the script location has a != HTTP scheme,
                // fall back to NetWebProxyFinder which supports also other schemes.
                if (netFinder == null)
                {
                    netFinder = new NetWebProxyFinder(engine);
                }
                currentFinder = netFinder;
                return currentFinder.GetProxies(destination, out proxyList);
            }

            return false;
        }

        public void Abort()
        {
            // Abor