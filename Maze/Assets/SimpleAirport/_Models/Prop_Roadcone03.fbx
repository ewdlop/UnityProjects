   }
            year{
                one{"{0}‡∞∏‡∞Ç"}
                other{"{0}‡∞∏‡∞Ç"}
            }
        }
        length{
            centimeter{
                one{"{0} ‡∞∏‡±Ü‡∞Ç.‡∞Æ‡±Ä"}
                other{"{0} ‡∞∏‡±Ü‡∞Ç.‡∞Æ‡±Ä"}
            }
            foot{
                one{"{0}‚Ä≤"}
                other{"{0}‚Ä≤"}
            }
            inch{
                one{"{0}‚Ä≥"}
                other{"{0}‚Ä≥"}
            }
            kilometer{
                one{"{0} ‡∞ï‡∞ø.‡∞Æ‡±Ä"}
                other{"{0} ‡∞ï‡∞ø.‡∞Æ‡±Ä"}
            }
            light-year{
                one{"{0} ‡∞ï‡∞æ‡∞Ç. ‡∞∏‡∞Ç"}
                other{"{0} ‡∞ï‡∞æ‡∞Ç. ‡∞∏‡∞Ç"}
            }
            meter{
                one{"{0} ‡∞Æ‡±Ä"}
                other{"{0} ‡∞Æ‡±Ä"}
            }
            mile{
                one{"{0} ‡∞Æ‡±à"}
                other{"{0} ‡∞Æ‡±à"}
            }
            millimeter{
                one{"{0} ‡∞Æ‡∞ø.‡∞Æ‡±Ä"}
                other{"{0} ‡∞Æ‡∞ø.‡∞Æ‡±Ä"}
            }
            picometer{
                one{"{0} ‡∞™‡∞ø.‡∞Æ‡±Ä"}
                other{"{0} ‡∞™‡∞ø.‡∞Æ‡±Ä"}
            }
            yard{
                one{"{0} ‡∞ó."}
                other{"{0} ‡∞ó."}
            }
        }
        mass{
            gram{
                one{"{0} ‡∞ó‡±ç‡∞∞‡∞æ."}
                other{"{0} ‡∞ó‡±ç‡∞∞‡∞æ."}
            }
            kilogram{
                one{"{0} ‡∞ï‡∞ø.‡∞ó‡±ç‡∞∞‡∞æ"}
                other{"{0} ‡∞ï‡∞ø.‡∞ó‡±ç‡∞∞‡∞æ"}
            }
            ounce{
                one{"{0} ‡∞î."}
                other{"{0} ‡∞î."}
            }
            pound{
                one{"{0} ‡∞™‡±å."}
                other{"{0} ‡∞™‡±å."}
            }
        }
        power{
            horsepower{
                one{"{0} ‡∞π‡∞æ.‡∞™"}
                other{"{0} ‡∞π‡∞æ.‡∞™"}
            }
            kilowatt{
                one{"{0} ‡∞ï‡∞ø.‡∞µ‡∞æ"}
                other{"{0} ‡∞ï‡∞ø.‡∞µ‡∞æ"}
            }
            watt{
                one{"{0} ‡∞µ‡∞æ."}
                other{"{0} ‡∞µ‡∞æ."}
            }
        }
        pressure{
            hectopascal{
                one{"{0} ‡∞π‡±Ü.‡∞™‡∞æ"}
                other{"{0} ‡∞π‡±Ü.‡∞™‡∞æ"}
            }
            inch-hg{
                one{"{0} ‡∞Ö‡∞Ç.‡∞™‡∞æ‡∞¶"}
                other{"{0} ‡∞Ö‡∞Ç.‡∞™‡∞æ‡∞¶"}
            }
            millibar{
                one{"{0} ‡∞Æ‡∞ø.‡∞¨‡∞æ‡∞∞‡±ç"}
                other{"{0} ‡∞Æ‡∞ø.‡∞¨‡∞æ‡∞∞‡±ç"}
            }
        }
        speed{
            kilometer-per-hour{
                one{"{0} ‡∞ï‡∞ø‡∞Æ‡±Ä/‡∞ó‡∞Ç."}
                other{"{0} ‡∞ï‡∞ø‡∞Æ‡±Ä/‡∞ó‡∞Ç."}
            }
            meter-per-second{
                one{"{0} ‡∞Æ‡±Ä/‡∞∏‡±Ü"}
                other{"{0} ‡∞Æ‡±Ä/‡∞∏‡±Ü"}
            }
            mile-per-hour{
                one{"{0} ‡∞Æ‡±à/‡∞ó‡∞Ç."}
                other{"{0} ‡∞Æ‡±à/‡∞ó‡∞Ç."}
            }
        }
        temperature{
            celsius{
                one{"{0}¬∞"}
                other{"{0}¬∞"}
            }
            fahrenheit{
                one{"{0}¬∞F"}
                other{"{0}¬∞F"}
            }
        }
        volume{
            cubic-kilometer{
                one{"{0} ‡∞ï‡∞ø‡∞Æ‡±Ä¬≥"}
                other{"{0} ‡∞ï‡∞ø‡∞Æ‡±Ä¬≥"}
            }
            cubic-mile{
                one{"{0} ‡∞Æ‡±à¬≥"}
                other{"{0} ‡∞Æ‡±à¬≥"}
            }
            liter{
                one{"{0} ‡∞≤‡±Ä."}
                other{"{0} ‡∞≤‡±Ä."}
            }
        }
    }
    unitsShort{
        acceleration{
            g-force{
                one{"{0} ‡∞ó‡±Å"}
                other{"{0} ‡∞ó‡±Å"}
            }
        }
        angle{
            arc-minute{
                one{"{0} ‡∞®‡∞ø‡∞Æ‡∞ø."}
                other{"{0} ‡∞®‡∞ø‡∞Æ‡∞ø."}
            }
            arc-second{
                one{"{0} ‡∞∏‡±Ü‡∞ï."}
                other{"{0} ‡∞∏‡±Ü‡∞ï."}
            }
            degree{
                one{"{0} ‡∞°‡∞ø."}
                other{"{0} ‡∞°‡∞ø."}
            }
        }
        area{
            acre{
                one{"{0} ‡∞é‡∞ï."}
                other{"{0} ‡∞é‡∞ï."}
            }
            hectare{
                one{"{0} ‡∞π‡±Ü."}
                other{"{0} ‡∞π‡±Ü."}
            }
            square-foot{
                one{"{0} ‡∞ö‡∞¶. ‡∞Ö."}
                other{"{0} ‡∞ö‡∞¶. ‡∞Ö."}
            }
            square-kilometer{
                one{"{0} ‡∞ï‡∞ø.‡∞Æ‡±Ä¬≤"}
                other{"{0} ‡∞ï‡∞ø.‡∞Æ‡±Ä¬≤"}
            }
            square-meter{
                one{"{0} ‡∞Æ‡±Ä¬≤"}
                other{"{0} ‡∞Æ‡±Ä¬≤"}
            }
            square-mile{
                one{"{0} ‡∞ö‡∞¶. ‡∞Æ‡±à."}
                other{"{0} ‡∞ö‡∞¶. ‡∞Æ‡±à."}
            }
        }
        compound{
            per{"{0}/{1}"}
        }
        duration{
            day{
                one{"{0} ‡∞∞‡±ã‡∞ú‡±Å"}
                other{"{0} ‡∞∞‡±ã‡∞ú‡±Å‡∞≤‡±Å"}
            }
            hour{
                one{"{0} ‡∞ó‡∞Ç‡∞ü"}
                other{"{0} ‡∞ó‡∞Ç‡∞ü‡∞≤‡±Å"}
            }
            millisecond{
                one{"{0} ‡∞Æ‡∞ø.‡∞∏‡±Ü"}
                other{"{0} ‡∞Æ‡∞ø.‡∞∏‡±Ü"}
            }
            minute{
                one{"{0} ‡∞®‡∞ø‡∞Æ‡∞ø."}
                other{"{0} ‡∞®‡∞ø‡∞Æ‡∞ø."}
            }
            month{
                one{"{0} ‡∞®‡±Ü‡∞≤"}
                other{"{0} ‡∞®‡±Ü‡∞≤‡∞≤‡±Å"}
            }
            second{
                one{"{0} ‡∞∏‡±Ü‡∞ï‡∞®‡±Å"}
                other{"{0} ‡∞∏‡±Ü‡∞ï‡∞®‡±ç‡∞≤‡±Å"}
            }
            week{
                one{"{0} ‡∞µ‡∞æ."}
                other{"{0} ‡∞µ‡∞æ."}
            }
            year{
                one{"{0} ‡∞∏‡∞Ç‡∞µ‡∞§‡±ç‡∞∏‡∞∞‡∞Ç"}
                other{"{0} ‡∞∏‡∞Ç‡∞µ‡∞§‡±ç‡∞∏‡∞∞‡∞æ‡∞≤‡±Å"}
            }
        }
        length{
            centimeter{
                one{"{0} ‡∞∏‡±Ü‡∞Ç.‡∞Æ‡±Ä"}
                other{"{0} ‡∞∏‡±Ü‡∞Ç.‡∞Æ‡±Ä"}
            }
            foot{
                one{"{0} ‡∞Ö."}
                other{"{0} ‡∞Ö."}
            }
            inch{
                one{"{0} ‡∞Ö‡∞Ç."}
                other{"{0} ‡∞Ö‡∞Ç."}
            }
            kilometer{
                one{"{0} ‡∞ï‡∞ø.‡∞Æ‡±Ä"}
                other{"{0} ‡∞ï‡∞ø.‡∞Æ‡±Ä"}
            }
            light-year{
                one{"{0} ‡∞ï‡∞æ‡∞Ç. ‡∞∏‡∞Ç"}
                other{"{0} ‡∞ï‡∞æ‡∞Ç. ‡∞∏‡∞Ç"}
            }
            meter{
                one{"{0} ‡∞Æ‡±Ä"}
                other{"{0} ‡∞Æ‡±Ä"}
            }
            mile{
                one{"{0} ‡∞Æ‡±à"}
                other{"{0} ‡∞Æ‡±à"}
            }
            millimeter{
                one{"{0} ‡∞Æ‡∞ø.‡∞Æ‡±Ä"}
                other{"{0} ‡∞Æ‡∞ø.‡∞Æ‡±Ä"}
            }
            picometer{
                one{"{0} ‡∞™‡∞ø.‡∞Æ‡±Ä"}
                other{"{0} ‡∞™‡∞ø.‡∞Æ‡±Ä"}
            }
            yard{
                one{"{0} ‡∞ó."}
                other{"{0} ‡∞ó."}
            }
        }
        mass{
            gram{
                one{"{0} ‡∞ó‡±ç‡∞∞‡∞æ."}
                other{"{0} ‡∞ó‡±ç‡∞∞‡∞æ."}
            }
            kilogram{
                one{"{0} ‡∞ï‡∞ø.‡∞ó‡±ç‡∞∞‡∞æ"}
                other{"{0} ‡∞ï‡∞ø.‡∞ó‡±ç‡∞∞‡∞æ"}
            }
            ounce{
                one{"{0} ‡∞î."}
                other{"{0} ‡∞î."}
            }
            pound{
                one{"{0} ‡∞™‡±å."}
                other{"{0} ‡∞™‡±å."}
            }
        }
        power{
            horsepower{
                one{"{0} ‡∞π‡∞æ.‡∞™"}
                other{"{0} ‡∞π‡∞æ.‡∞™"}
            }
            kilowatt{
                one{"{0} ‡∞ï‡∞ø.‡∞µ‡∞æ"}
                other{"{0} ‡∞ï‡∞ø.‡∞µ‡∞æ"}
            }
            watt{
                one{"{0} ‡∞µ‡∞æ."}
                other{"{0} ‡∞µ‡∞æ."}
            }
        }
        pressure{
            hectopascal{
                one{"{0} ‡∞π‡±Ü.‡∞™‡∞æ"}
                other{"{0} ‡∞π‡±Ü.‡∞™‡∞æ"}
            }
            inch-hg{
                one{"{0} ‡∞Ö‡∞Ç.‡∞™‡∞æ‡∞¶"}
                other{"{0} ‡∞Ö‡∞Ç.‡∞™‡∞æ‡∞¶"}
            }
            millibar{
                one{"{0} ‡∞Æ‡∞ø.‡∞¨‡∞æ‡∞∞‡±ç"}
                other{"{0} ‡∞Æ‡∞ø.‡∞¨‡∞æ‡∞∞‡±ç"}
            }
        }
        speed{
            kilometer-per-hour{
                one{"{0} ‡∞ï‡∞ø/‡∞ó‡∞Ç."}
                other{"{0} ‡∞ï‡∞ø‡∞Æ‡±Ä/‡∞ó‡∞Ç."}
            }
            meter-per-second{
                one{"{0} ‡∞Æ‡±Ä/‡∞∏‡±Ü"}
                other{"{0} ‡∞Æ‡±Ä/‡∞∏‡±Ü"}
            }
            mile-per-hour{
                one{"{0} ‡∞Æ‡±à/‡∞ó‡∞Ç."}
                other{"{0} ‡∞Æ‡±à/‡∞ó‡∞Ç."}
            }
        }
        temperature{
            celsius{
                one{"{0}¬∞C"}
                other{"{0}¬∞C"}
            }
            fahrenheit{
                one{"{0}¬∞F"}
                other{"{0}¬∞F"}
            }
        }
        volume{
            cubic-kilometer{
                one{"{0} ‡∞ï‡∞ø‡∞Æ‡±Ä¬≥"}
                other{"{0} ‡∞ï‡∞ø‡∞Æ‡±Ä¬≥"}
            }
            cubic-mile{
                one{"{0} ‡∞Æ‡±à¬≥"}
                other{"{0} ‡∞Æ‡±à¬≥"}
            }
            liter{
                one{"{0} ‡∞≤‡±Ä."}
                other{"{0} ‡∞≤‡±Ä."}
            }
        }
    }
}
                                                                                                                             (ug¿¥¿%Ñ¨§.(⁄u∂ÄÀÅıîÚoPoÛ[Ê—Ω¿›§§dŒWB>_+Ök1åÆπZããÅt{n4Ó–Eè@í˛(j£^5®äÑJ∑√Ωy aaØUƒ…Æ	ƒ‚ c´úrK/ro•lH‡¯~_KÉK
¿ut_czÂM·ÿÌîxÑ©rπù[©NY·πvªÀ◊ï¨‡áIh°b‡ô"ôﬂ‚&˙Yîd:áãI˛AlÊ
&Õ˚¨±pÏ+ù>£37)BMª‡ı≤xüXÍáÌ~GìÃˇôÑ≤1©ä·{#äÚ€Ÿ‰oUHó$XP=Q"ûﬁÃ¢‡úê˜ª‹/¿£9cgi›[Ø;œïC˜ƒóNXŸ ˇE¶¨ŸtØı,{áH∆∫D^º†Æ~È≤*èvvØÔbçñ’Ò”∂mê€é°à⁄à˘”µÈ~€zCëÕ∞ê<Ê[W„h⁄jwE(Í›à}æOÅﬁëA◊iø0ku+M–—‡!ï4’_Íœ&hΩajõ‚ÔÕä•]|Å¥Â\ë“‚_q·˜é4¡V,H%Õ”Ø#>)˛8ã7N›ö«^≈l≥Èê}±^?òaA7ºKöÖı‚ßï=ä	§T¬J2±µMü•mÀûÊ%S∑ioÏ¿€"4ãƒÃpo‹7Å`'ÎóìYE[waò@:®‘Ë∞P6Góc*}±$Vñ>AïÆ≥mNﬁı›ˇ‰)|I"Ûy‚•)Yæ7é´V{ΩskóÄœ‰àÍ–à5˝môì$`÷:é~:=Q¿»¡
˝ﬂà9p\≤•6DÂt‡p≥b∂‚ˆˆÅ\ÜÈ≈’ﬁhQùd„(ïò#˚ææ∏¸ﬁö¬8Õ;πÕN9vG9"6]ËEŒG«A¢Zµ1ÀmùÒ?€îÔNó÷fE≈dÊ†€ò∑¬§ë& Ωs§Hı¥àÀı…wı<B∏e('ˆÇÎ∏àß‰ˇ„Äcäz§»≠\$ŒÔM:—|N∆a‘˝ÈåÙgÆg˙w‘O·Ç	˘}ÉPÎ«û4˘ÓÅg@≤Ïtç3KIﬂ˛Cn?l∂FÙJá«YÖGß
 ûÍ!qH˛-í7W∫‘…,/ŸÉwÖÇπÆ¥Æ¥Ñó„tWwøÆM7ÜwBg–ºÉ≠IBπsÉêpõ◊º”7•è°Éÿ7±€µ&ßÌuœÄõÅØ.}?ÏÛLbå[súo<Y;œ°ÊÃf.±c‡äb√Ã˙ j≥ÚÂ~Sd§2Kπp≠òWÒÓ&ı–®®6¿≤]≈S¶‡ëÒ¨ê5§fÚ∞ÈáQ÷¨Aña¢•ä«ÈNƒ+ø€f´ó%g!™ˆ"†ë≤ˇë˘#ÆÊ°X∂◊D@(aÍó—EY(¡jÉ¸…⁄≥yŒ§\|V%bÆçr!¸˚…ﬁiÿË√¨¿J(ú	¨öxì]±[À˚ëxï»g‘Ó¨%ì.Gò3ÊP—Ô’`5“a	√F[ö∏%%XÎÉæ‡TÉÎ
*íÀQPÏß∏HÄãD0gô«r˜›‰n≥äÆüE9ãSEF˚ P≠∏‰co◊Ä´S∞R\≠á”ˆ€˘Éß€öí.ﬂÏîA=9zØøÅı§2-ÒP≤H€¡’Ø_Ñı≥èZÂÁ˝ÆÉÔp\∏&∫§Õ∞y¬J3—ﬂ+[ùHÈÛíÙ∏ü á`i˚ÓD(g‘ÌˆÇs!;éﬁ⁄(aö∏WLË⁄G·±8Ÿ\!ÜÄÚ‚â={%Cƒ¨äƒzrCı◊‘E—’·˙cˇ–≥-gÉ^ﬂf"ﬁ5Q®g¸SWØÉ6é|ÈõmMÆ–„ü(ƒÏˆ4˛@›7Ÿ°W¿ú∑gÏ1ÙôlJjÄÎŸÃ–◊ÄDA˛BA∂_¨äÿŸ√“]–÷»É˙º¨\ÊÇk[˝g˙zcÃ´è÷∑˜ä^8RÈÎrâØ^Æ‡Ï∂Œ!t°¸∏Ùd R;≠ ?ÍΩr’∏ßΩ»=$∫(G˚-≈$jv8B}‚PÒ€0¢Vo⁄Öã˜Tb¸Fr#≠*∞€±œÙu¶›gﬁ
‰t64£Hcc_ÉÜ
îÌD≈!lÂ€/!!>ÿ„(˘◊Çìs"µ9÷‡]ú»Œx˝√Ì¨?O®?[-‰–cX‡˛Yπd«¬¡wßÉóÓc
g]ä6óÂ ©ï]óªÚ]ùhŸØWô®∞⁄JyÖ!ó◊ôµoa9}›¿*¥æaz)´A j£è^Ç?‹ÕﬂDx™·	⁄ƒ^î ÀáÑÙ’¨òÎ+˜Èw°≤‰a«Ø"}2Åıã≠PPÀ»Äx{∏óãQ,ÈÑåÑó]∆INÊÔ∆V}û+≤≠Ùå”€?∆<_øü
xùbÌÒ≈ó≤öÄJk∂o¨3á€À‘t†!80"˘å?çøû{π® 3ûÖ·ıΩÏ·Ú]«5(+çbhdöÇLZÄ“tc	%.•◊úM¢ÌxölËOy<"¡6Èëöƒ[rùÏë˘fX!ô,JÄ;˙N8ƒ»e*l‚I˝°˙8[±Ÿ◊Œ+˝T’≥Zî¡x‹ÀÀ´Izã4é$ß∂ˆ&a˛Ó≥c”\u/NÌ[®Pt€Y-~Û¢-≈TÄ¸Ë'VdÑ∂P(
N1l~]ü5Dß´G•¢≥|˛Ùø˝:tSÂ÷Ñ µÇîÒË‹QΩõßË…Œá˝áÁ’´?ûdúp«ö∆ËÖËa°¥	X÷æyÏˆ˜ˆíø€óe∫ç–Á~C∏x5TøyÏ(ãé≠ıØÊŒé÷nµ([M%kt≠j∞ò¢≠∆éq‡ø¨ÂáT!ÊX€OXe"aˆIÉ-}f ö‰ë	t˝‰f*£Ç†XØÿˆµ9ÑÕ·œAÑîc-KT–”{5eÆÖwôqä∆ï Ñåûi-ü
xw6f;:‚¿¡·Î¯å√ü Ò	_ÄKÏqçQÕ6-⁄·?ÁbÑ{˜¨‰ tû`X™∏VﬁßuTÒÆÕ\EÙwâg)%ã~â`Ö!
ÑàWˆcõ/•‘q†.pÂE=µ~Ø∏•%ÕH´f∆Ò≥≤Ãd‘@@Q9ñÒ‡G€^ïªƒ6ù¥:f∏:D–ã¯Û£Fn€¬πƒÁïàLA±ÏÎPb\∞MQcÈü˜`…]ù3Hˇ≤ÂRxü‘∆ ˚-,Ú!gñ@≥Qè´:éâª∆èH»ÊÚ»⁄øJ4Qÿfy© ∆ŸL2Ø+ûIAç’®¢‹|q2˙”Ø˜æ¿πCT&Æ[JCW¸πëÑÓ~Étß‘Y+“Gûeë?∞¿áS⁄4√Yë7ÿÁ∂äˇ»Ê*2Û#fàej˛„i{±S√J!g¨Lî˚a{iféy¶dÇ{ı”D˜ú≤"∂#0Y·}ó»r81‹˜ù÷@(ÛRD«Á/Z(ıF‹ü–Ès a®;/*
*******************************************************************************
* Copyright (C) 1997-2014, International Business Machines Corporation and
* others. All Rights Reserved.
*******************************************************************************
*
* File TIMEZONE.CPP
*
* Modification History:
*
*   Date        Name        Description
*   12/05/96    clhuang     Creation.
*   04/21/97    aliu        General clean-up and bug fixing.
*   05/08/97    aliu        Fixed Hashtable code per code review.
*   07/09/97    helena      Changed createInstance to createDefault.
*   07/29/97    aliu        Updated with all-new list of 96 UNIX-derived
*                           TimeZones.  Changed mechanism to load from static
*                           array rather than resource bundle.
*   07/07/1998  srl         Bugfixes from the Java side: UTC GMT CAT NST
*                           Added getDisplayName API
*                           going to add custom parsing.
*
*                           ISSUES:
*                               - should getDisplayName cache something?
*                               - should custom time zones be cached? [probably]
*  08/10/98     stephen     Brought getDisplayName() API in-line w/ conventions
*  08/19/98     stephen     Changed createTimeZone() to never return 0
*  09/02/98     stephen     Added getOffset(monthLen) and hasSameRules()
*  09/15/98     stephen     Added getStaticClassID()
*  02/22/99     stephen     Removed character literals for EBCDIC safety
*  05/04/99     stephen     Changed initDefault() for Mutex issues
*  07/12/99     helena      HPUX 11 CC Port.
*  12/03/99     aliu        Moved data out of static table into icudata.dll.
*                           Substantial rewrite of zone lookup, default zone, and
*                           available IDs code.  Misc. cleanup.
*********************************************************************************/

#include "utypeinfo.h"  // for 'typeid' to work

#include "unicode/utypes.h"
#include "unicode/ustring.h"
#include "uassert.h"
#include "ustr_imp.h"

#ifdef U_DEBUG_TZ
# include <stdio.h>
# include "uresimp.h" // for debugging

static void debug_tz_loc(const char *f, int32_t l)
{
  fprintf(stderr, "%s:%d: ", f, l);
}

static void debug_tz_msg(const char *pat, ...)
{
  va_list ap;
  va_start(ap, pat);
  vfprintf(stderr, pat, ap);
  fflush(stderr);
}
static char gStrBuf[256];
#define U_DEBUG_TZ_STR(x) u_austrncpy(gStrBuf,x,sizeof(gStrBuf)-1)
// must use double parens, i.e.:  U_DEBUG_TZ_MSG(("four is: %d",4));
#define U_DEBUG_TZ_MSG(x) {debug_tz_loc(__FILE__,__LINE__);debug_tz_msg x;}
#else
#define U_DEBUG_TZ_MSG(x)
#endif

#if !UCONFIG_NO_FORMATTING

#include "unicode/simpletz.h"
#include "unicode/calendar.h"
#include "unicode/gregocal.h"
#include "unicode/ures.h"
#include "unicode/tzfmt.h"
#include "unicode/numfmt.h"
#include "gregoimp.h"
#include "uresimp.h" // struct UResourceBundle
#include "olsontz.h"
#include "mutex.h"
#include "unicode/udata.h"
#include "ucln_in.h"
#include "cstring.h"
#include "cmemory.h"
#include "unicode/strenum.h"
#include "uassert.h"
#include "zonemeta.h"

#define kZONEINFO "zoneinfo64"
#define kREGIONS  "Regions"
#define kZONES    "Zones"
#define kRULES    "Rules"
#define kNAMES    "Names"
#define kTZVERSION  "TZVersion"
#define kLINKS    "links"
#define kMAX_CUSTOM_HOUR    23
#define kMAX_CUSTOM_MIN     59
#define kMAX_CUSTOM_SEC     59
#define MINUS 0x002D
#define PLUS 0x002B
#define ZERO_DIGIT 0x0030
#define COLON 0x003A

// Static data and constants

static const UChar         WORLD[] = {0x30, 0x30, 0x31, 0x00}; /* "001" */

static const UChar         GMT_ID[] = {0x47, 0x4D, 0x54, 0x00}; /* "GMT" */
static const UChar         UNKNOWN_ZONE_ID[] = {0x45, 0x74, 0x63, 0x2F, 0x55, 0x6E, 0x6B, 0x6E, 0x6F, 0x77, 0x6E, 0x00}; /* "Etc/Unknown" */
static const int32_t       GMT_ID_LENGTH = 3;
static const int32_t       UNKNOWN_ZONE_ID_LENGTH = 11;

static icu::TimeZone* DEFAULT_ZONE = NULL;
static icu::UInitOnce gDefaultZoneInitOnce = U_INITONCE_INITIALIZER;

static icu::TimeZone* _GMT = NULL;
static icu::TimeZone* _UNKNOWN_ZONE = NULL;
static icu::UInitOnce gStaticZonesInitOnce = U_INITONCE_INITIALIZER;

static char TZDATA_VERSION[16];
static icu::UInitOnce gTZDataVersionInitOnce = U_INITONCE_INITIALIZER;

static int32_t* MAP_SYSTEM_ZONES = NULL;
static int32_t* MAP_CANONICAL_SYSTEM_ZONES = NULL;
static int32_t* MAP_CANONICAL_SYSTEM_LOCATION_ZONES = NULL;

static int32_t LEN_SYSTEM_ZONES = 0;
static int32_t LEN_CANONICAL_SYSTEM_ZONES = 0;
static int32_t LEN_CANONICAL_SYSTEM_LOCATION_ZONES = 0;

static icu::UInitOnce gSystemZonesInitOnce = U_INITONCE_INITIALIZER;
static icu::UInitOnce gCanonicalZonesInitOnce = U_INITONCE_INITIALIZER;
static icu::UInitOnce gCanonicalLocationZonesInitOnce = U_INITONCE_INITIALIZER;

U_CDECL_BEGIN
static UBool U_CALLCONV timeZone_cleanup(void)
{
    U_NAMESPACE_USE
    delete DEFAULT_ZONE;
    DEFAULT_ZONE = NULL;
    gDefaultZoneInitOnce.reset();

    delete _GMT;
    _GMT = NULL;
    delete _UNKNOWN_ZONE;
    _UNKNOWN_ZONE = NULL;
    gStaticZonesInitOnce.reset();

    uprv_memset(TZDATA_VERSION, 0, sizeof(TZDATA_VERSION));
    gTZDataVersionInitOnce.reset();

    LEN_SYSTEM_ZONES = 0;
    uprv_free(MAP_SYSTEM_ZONES);
    MAP_SYSTEM_ZONES = 0;
    gSystemZonesInitOnce.reset();

    LEN_CANONICAL_SYSTEM_ZONES = 0;
    uprv_free(MAP_CANONICAL_SYSTEM_ZONES);
    MAP_CANONICAL_SYSTEM_ZONES = 0;
    gCanonicalZonesInitOnce.reset();

    LEN_CANONICAL_SYSTEM_LOCATION_ZONES = 0;
    uprv_free(MAP_CANONICAL_SYSTEM_LOCATION_ZONES);
    MAP_CANONICAL_SYSTEM_LOCATION_ZONES = 0;
    gCanonicalLocationZonesInitOnce.reset();

    return TRUE;
}
U_CDECL_END

U_NAMESPACE_BEGIN

static int32_t findInStringArray(UResourceBundle* array, const UnicodeString& id, UErrorCode &status)
{
    UnicodeString copy;
    const UChar *u;
    int32_t len;

    int32_t start = 0;
    int32_t limit = ures_getSize(array);
    int32_t mid;
    int32_t lastMid = INT32_MAX;
    if(U_FAILURE(status) || (limit < 1)) {
        return -1;
    }
    U_DEBUG_TZ_MSG(("fisa: Looking for %s, between %d and %d\n", U_DEBUG_TZ_STR(UnicodeString(id).getTerminatedBuffer()), start, limit));

    for (;;) {
        mid = (int32_t)((start + limit) / 2);
        if (lastMid == mid) {   /* Have we moved? */
            break;  /* We haven't moved, and it wasn't found. */
        }
        lastMid = mid;
        u = ures_getStringByIndex(array, mid, &len, &status);
        if (U_FAILURE(status)) {
            break;
        }
        U_DEBUG_TZ_MSG(("tz: compare to %s, %d .. [%d] .. %d\n", U_DEBUG_TZ_STR(u), start, mid, limit));
        copy.setTo(TRUE, u, len);
        int r = id.compare(copy);
        if(r==0) {
            U_DEBUG_TZ_MSG(("fisa: found at %d\n", mid));
            return mid;
        } else if(r<0) {
            limit = mid;
        } else {
            start = mid;
        }
    }
    U_DEBUG_TZ_MSG(("fisa: not found\n"));
    return -1;
}

/**
 * Fetch a specific zone by name.  Replaces the getByKey call.
 * @param top Top timezone resource
 * @param id Time zone ID
 * @param oldbundle Bundle for reuse (or NULL).   see 'ures_open()'
 * @return the zone's bundle if found, or undefined if error.  Reuses oldbundle.
 */
static UResourceBundle* getZoneByName(const UResourceBundle* top, const UnicodeString& id, UResourceBundle *oldbundle, UErrorCode& status) {
    // load the Rules object
    UResourceBundle *tmp = ures_getByKey(top, kNAMES, NULL, &status);

    // search for the string
    int32_t idx = findInStringArray(tmp, id, status);

    if((idx == -1) && U_SUCCESS(status)) {
        // not found
        status = U_MISSING_RESOURCE_ERROR;
        //ures_close(oldbundle);
        //oldbundle = NULL;
    } else {
        U_DEBUG_TZ_MSG(("gzbn: oldbundle= size %d, type %d, %s\n", ures_getSize(tmp), ures_getType(tmp), u_errorName(status)));
        tmp = ures_getByKey(top, kZONES, tmp, &status); // get Zones object from top
        U_DEBUG_TZ_MSG(("gzbn: loaded ZONES, size %d, type %d, path %s %s\n", ures_getSize(tmp), ures_getType(tmp), ures_getPath(tmp), u_errorName(status)));
        oldbundle = ures_getByIndex(tmp, idx, oldbundle, &status); // get nth Zone object
        U_DEBUG_TZ_MSG(("gzbn: loaded z#%d, size %d, type %d, path %s, %s\n", idx, ures_getSize(oldbundle), ures_getType(oldbundle), ures_getPath(oldbundle),  u_errorName(status)));
    }
    ures_close(tmp);
    if(U_FAILURE(status)) {
        //ures_close(oldbundle);
        return NULL;
    } else {
        return oldbundle;
    }
}


UResourceBundle* TimeZone::loadRule(const UResourceBundle* top, const UnicodeString& ruleid, UResourceBundle* oldbundle, UErrorCode& status) {
    char key[64];
    ruleid.extract(0, sizeof(key)-1, key, (int32_t)sizeof(key)-1, US_INV);
    U_DEBUG_TZ_MSG(("loadRule(%s)\n", key));
    UResourceBundle *r = ures_getByKey(top, kRULES, oldbundle, &status);
    U_DEBUG_TZ_MSG(("loadRule(%s) -> kRULES [%s]\n", key, u_errorName(status)));
    r = ures_getByKey(r, key, r, &status);
    U_DEBUG_TZ_MSG(("loadRule(%s) -> item [%s]\n", key, u_errorName(status)));
    return r;
}

/**
 * Given an ID, open the appropriate resource for the given time zone.
 * Dereference aliases if necessary.
 * @param id zone id
 * @param res resource, which must be ready for use (initialized but not open)
 * @param ec input-output error code
 * @return top-level resource bundle
 */
static UResourceBundle* openOlsonResource(const UnicodeString& id,
                                          UResourceBundle& res,
                                          UErrorCode& ec)
{
#if U_DEBUG_TZ
    char buf[128];
    id.extract(0, sizeof(buf)-1, buf, sizeof(buf), "");
#endif
    UResourceBundle *top = ures_openDirect(0, kZONEINFO, &ec);
    U_DEBUG_TZ_MSG(("pre: res sz=%d\n", ures_getSize(&res)));
    /* &res = */ getZoneByName(top, id, &res, ec);
    // Dereference if this is an alias.  Docs say result should be 1
    // but it is 0 in 2.8 (?).
    U_DEBUG_TZ_MSG(("Loading zone '%s' (%s, size %d) - %s\n", buf, ures_getKey((UResourceBundle*)&res), ures_getSize(&res), u_errorN