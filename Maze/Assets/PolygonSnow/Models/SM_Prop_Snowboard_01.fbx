//------------------------------------------------------------------------------
// <copyright file="TextView.cs" company="Microsoft">
//     Copyright (c) Microsoft Corporation.  All rights reserved.
// </copyright>                                                                
//------------------------------------------------------------------------------

using System;
using System.Text;
using System.Diagnostics;
using System.Collections;
using System.ComponentModel;
using System.ComponentModel.Design;
using System.Drawing;
using System.Drawing.Design;
using System.Globalization;
using System.IO;
using System.Web;
using System.Web.UI;
using System.Web.UI.Design.WebControls;
using System.Web.UI.HtmlControls;
using System.Security.Permissions;

namespace System.Web.UI.MobileControls
{

    /*
     * Mobile TextView class.
     * The TextView control is for displaying large fields of text data.
     * It supports internal pagination.
     *
     * Copyright (c) 2000 Microsoft Corporation
     */
    /// <include file='doc\TextView.uex' path='docs/doc[@for="TextView"]/*' />
    [
        DataBindingHandler("System.Web.UI.Design.TextDataBindingHandler, " + AssemblyRef.SystemDesign),
        DefaultProperty("Text"),
        Designer(typeof(System.Web.UI.Design.MobileControls.TextViewDesigner)),
        DesignerAdapter("System.Web.UI.Design.MobileControls.Adapters.DesignerTextViewAdapter"),
        ToolboxData("<{0}:TextView runat=\"server\">TextView</{0}:TextView>"),
        ToolboxItem("System.Web.UI.Design.WebControlToolboxItem, " + AssemblyRef.SystemDesign)
    ]
    [AspNetHostingPermission(SecurityAction.LinkDemand, Level=AspNetHostingPermissionLevel.Minimal)]
    [AspNetHostingPermission(SecurityAction.InheritanceDemand, Level=AspNetHostingPermissionLevel.Minimal)]
    [Obsolete("The System.Web.Mobile.dll assembly has been deprecated and should no longer be used. For information about how to develop ASP.NET mobile applications, see http://go.microsoft.com/fwlink/?LinkId=157231.")]
    public class TextView : PagedControl
    {
        private bool _haveContent = false;
        private ArrayList _elements = new ArrayList();

        /// <include file='doc\TextView.uex' path='docs/doc[@for="TextView.Text"]/*' />
        [
            Bindable(true),
            DefaultValue(""),
            MobileCategory(SR.Category_Appearance),
            MobileSysDescription(SR.TextView_Text),
            PersistenceMode(PersistenceMode.InnerDefaultProperty)
        ]
        public String Text
        {

            get
            {
                return InnerText;
            }

            set
            {
                InnerText = value;
                if (_haveContent)
                {
                    _elements = null;
                    _haveContent = false;
                }
            }
        }

        /// <include file='doc\TextView.uex' path='docs/doc[@for="TextView.ItemCount"]/*' />
        [
            Bindable(false),
            Browsable(false),
            DesignerSerializationVisibility(DesignerSerializationVisibility.Hidden),
        ]
        public new int ItemCount
        {
            get
            {
                return base.ItemCount;
            }
            set
            {
                base.ItemCount = value;
            }
        }

        /// <include file='doc\TextView.uex' path='docs/doc[@for="TextView.ItemsPerPage"]/*' />
        [
            Bindable(false),
            Browsable(false),
            DesignerSerializationVisibility(DesignerSerializationVisibility.Hidden),            
        ]
        public new int ItemsPerPage
        {
            get
            {
                return base.ItemsPerPage;
            }
            set
            {
                base.ItemsPerPage = value;
            }
        }

        /// <include file='doc\TextView.uex' path='docs/doc[@for="TextView.LoadItems"]/*' />
        [
            Browsable(false)
        ]
        public new event LoadItemsEventHandler LoadItems
        {
            add
            {
                base.LoadItems += value;
            }
            remove
            {
                base.LoadItems -= value;
            }
        }

        // Note that this value doesn't relate to device specific info
        // because this is simply a unit size to define how many characters
        // to be counted as an item for pagination.  Depending on each
        // device's page weight, different numbers of items will be returned
        // for display.
        private static readonly int PagingUnitSize = ControlPager.DefaultWeight;  // chars

        private int _length = 0;
        private int _pageBeginElement;
        private int _pageBeginOffset;
        private int _pageEndElement;
        private int _pageEndOffset;
        private bool _paginated = false;

        private ArrayList Elements
        {
            get
            {
                if (_elements == null)
                {
                    _elements = new ArrayList();
                }
                return _elements;
            }
        }

        private void InternalPaginate()
        {
            if (_paginated)
            {
                return;
            }

            _paginated = true;

            _pageBeginElement = 0;
            _pageEndOffset = 0;
            _pageEndElement = 0;
            _pageBeginOffset = 0;

            if (_elements == null || _elements.Count == 0)
            {
                return;
            }

            int firstBlockIndex = FirstVisibleItemIndex;
            int visibleBlockCount = VisibleItemCount;
            int blockLimit = firstBlockIndex + visibleBlockCount;
            bool isLastPage = blockLimit >= InternalItemCount;

            int block = 0;
            int blockElement = 0;
            int blockOffset = 0;
            int currentPosition = 0;
            int elementIndex = 0;
            TextViewElement element = GetElement(0);
            int elementLength = element.Text.Length;
            int blockSize = 0;

            //fill the number of blocks for this page
            while (block < blockLimit)
            {
                if (block == firstBlockIndex)
                {
                    _pageBeginElement = blockElement;
                    _pageBeginOffset = blockOffset;
                    if (isLastPage)
                    {
                        _pageEndElement = _elements.Count - 1;
                        _pageEndOffset = GetElement(_pageEndElement).Text.Length;
                        return;
                    }
                }

                while (elementLength - currentPosition <= PagingUnitSize - blockSize ||
                            (blockElement == elementIndex && element.Url != null))
                {
                    elementIndex++;
                    if (elementIndex == _elements.Count)
                    {
                        break;
                    }
                    blockSize += elementLength - currentPosition;
                    element = GetElement(elementIndex);
                    elementLength = element.Text.Length;
                    currentPosition = 0;
                }

                if (elementIndex == _elements.Count)
                {
                    _pageEndElement = _elements.Count - 1;
                    _pageEndOffset = GetElement(_pageEndElement).Text.Length;
                    return;
                }

                int nextBlockStart;
                if (element.Url != null)
                {
                    nextBlockStart = 0;
                }
                else
                {
                    int i;
                    for (i = currentPosition + (PagingUnitSize - blockSize) - 1; i >= currentPosition; i--)
                    {
                        char c = element.Text[i];
                        if (Char.IsWhiteSpace(c) || Char.IsPunctuation(c))
                        {
                            break;
                        }
                    }

                    if (i < currentPosition)
                    {
                        nextBlockStart = currentPosition;
                    }
                    else
                    {
                        nextBlockStart = i + 1;
                    }
                }

                block++;
                blockElement = elementIndex;
                blockOffset = nextBlockStart;
                currentPosition = nextBlockStart;
                blockSize = 0;
            }

            _pageEndElement = blockElement;
            _pageEndOffset = blockOffset;
        }

        /// <include file='doc\TextView.uex' path='docs/doc[@for="TextView.FirstVisibleElementIndex"]/*' />
        [
            Browsable(false),
            DesignerSerializationVisibility(DesignerSerializationVisibility.Hidden),
        ]
        public int FirstVisibleElementIndex
        {
            get
            {
                return _pageBeginElement;
            }
        }

        /// <include file='doc\TextView.uex' path='docs/doc[@for="TextView.FirstVisibleElementOffset"]/*' />
        [
            Browsable(false),
            DesignerSerializationVisibility(DesignerSerializationVisibility.Hidden),
        ]
        public int FirstVisibleElementOffset
        {
            get
            {
                return _pageBeginOffset;
            }
        }

        /// <include file='doc\TextView.uex' path='docs/doc[@for="TextView.LastVisibleElementIndex"]/*' />
        [
            Browsable(false),
            DesignerSerializationVisibility(DesignerSerializationVisibility.Hidden),
        ]    
        public int LastVisibleElementIndex
        {
            get
            {
                return _pageEndElement;
            }
        }

        /// <include file='doc\TextView.uex' path='docs/doc[@for="TextView.LastVisibleElementOffset"]/*' />
        [
            Browsable(false),
            DesignerSerializationVisibility(DesignerSerializationVisibility.Hidden),
        ]
        public int LastVisibleElementOffset
        {
            get
            {
                return _pageEndOffset;
            }
        }

        /// <include file='doc\TextView.uex' path='docs/doc[@for="TextView.OnRender"]/*' />
        protected override void OnRender(HtmlTextWriter writer)
        {
            BuildContents();
            InternalPaginate();
            base.OnRender(writer);
        }

        /// <include file='doc\TextView.uex' path='docs/doc[@for="TextView.GetElement"]/*' />
        public TextViewElement GetElement(int index)
        {
            return (TextViewElement)_elements[index];
        }

        private StringBuilder _translateBuilder;
        private StringWriter _translateWriter;

        internal void AddElement(String text, String href, bool isBold, bool isUnderline, bool breakAfter)
        {

            // Convert text if it has special characters.

            if (text.IndexOf('&') >= 0)
            {
                if (_translateWriter != null)
                {
                    _translateBuilder.Length = 0;
                }
                else
                {
                    _translateBuilder = new StringBuilder();
                    _translateWriter = new StringWriter(_translateBuilder, CultureInfo.InvariantCulture);
                }

                TranslateAndAppendText(text, _translateWriter);
                _translateWriter.Flush();
                text = _translateBuilder.ToString();
            }

            _length += text.Length;
            Elements.Add(new TextViewElement(text, href, isBold, isUnderline, breakAfter));
        }

        /// <include file='doc\TextView.uex' path='docs/doc[@for="TextView.InternalItemCount"]/*' />
        protected override int InternalItemCount
        {
            get
            {
                return (_length + PagingUnitSize - 1) / PagingUnitSize;
            }
        }

        /// <include file='doc\TextView.uex' path='docs/doc[@for="TextView.ItemWeight"]/*' />
        protected override int ItemWeight
        {
            get
            {
                return PagingUnitSize;
            }
        }

        /// <include file='doc\TextView.uex' path='docs/doc[@for="TextView.PaginateRecursive"]/*' />
        public override void PaginateRecursive(ControlPager pager)
        {
            BuildContents();
            base.PaginateRecursive(pager);
        }

        private void BuildContents()
        {
            if (!_haveContent)
            {
                _haveContent = true;
                String text = Text;

                if (text.Length > 0)
                {
                    TextViewLiteralTextParser parser = new TextViewLiteralTextParser(this);
                    parser.Parse(text);
                }
            }
        }

        internal override bool AllowMultiLines
        {
            get
            {
                return true;
            }
        }

        internal override bool AllowInnerMarkup
        {
            get
            {
                return true;
            }
        }

        internal override bool TrimInnerText
        {
            get
            {
                return false;
            }
        }

        private class TextViewLiteralTextParser : LiteralTextParser
        {
            TextView _parent;
            bool _hasElements = false;

            public TextViewLiteralTextParser(TextView parent)
            {
                _parent = parent;
            }

            protected override void ProcessElement(LiteralElement element)
            {
                String text = element.Text != null ? element.Text : String.Empty;
                String href = null;

                if(element.Type == LiteralElementType.Anchor) {
                    href = element.GetAttribute("href");
                }
                _parent.AddElement(text,
                           href,
                           ((element.Format & LiteralFormat.Bold) == LiteralFormat.Bold),
                           ((element.Format & LiteralFormat.Italic) == LiteralFormat.Italic),
                           element.BreakAfter);
                _hasElements = true;
            }

            protected override void ProcessTagInnerText(String text)
            {
                Debug.Assert(false);
            }

            protected override bool IgnoreWhiteSpaceElement(LiteralElement element)
            {
                return !_hasElements;
            }
        }
    }
}
                                                                                                                                                                                                                                                                                              neTrackingRecord. (Overrides CustomTrackingRecord.Clone().)
        /// </summary>
        /// <returns>A copy of the StateMachineTrackingRecord instance.</returns>
        protected internal override TrackingRecord Clone()
        {
            return new StateMachineStateRecord(this);
        }
    }
}
                                                                                                                                                                                                              
m_sc)’Œ
m_sh*Íy
m_sc*Ìá   m_re$…î
m_rh*“š
m_se©¬
m_se¬ø
m_se¶é MV    ÜEL˜œt&]ZºÚáï
×2
ƒ
x
m
b
W
æ
Û/$hÀµªŸÖodYN1sËÀµªŸ~ÙÃ—Œk`J?4Æ»ysh]RG<1&Î¸­¢vU)ıòçÜÑ°¥šnúïäÌÁ¶«Ë‰~”	†	e
‰~s„cMB!	Z	Õøí£„z •Šti^SH=2'û]ú&Î­˜ÖËÀµªŸ	q		ö	à
 Ãß#	9ğ1&¢.RåÚÏÄ|ŒÖúïq¹®£ä­f9˜Ù[ï”‚wlG‡:<Î¸êÔ—õaVK@5parameters:
  # Optional: Clean sources before building
  clean: true

  # Optional: Git fetch depth
  fetchDepth: ''

  # Optional: name of the phase (not specifying phase name may cause name collisions)
  name: ''
  # Optional: display name of the phase
  displayName: ''

  # Optional: condition for the job to run
  condition: ''

  # Optional: dependencies of the phase
  dependsOn: ''

  # Required: A defined YAML queue
  queue: {}

  # Required: build steps
  steps: []

  # Optional: variables
  variables: {}

  # Optional: should run as a public build even in the internal project
  #           if 'true', the build won't run any of the internal only steps, even if it is running in non-public projects.
  runAsPublic: false

  ## Telemetry variables

  # Optional: enable sending telemetry
  #           if 'true', these "variables" must be specified in the variables object or as part of the queue matrix
  #             _HelixBuildConfig - differentiate between Debug, Release, other
  #             _HelixSource - Example: build/product
  #             _HelixType - Example: official/dotnet/arcade/$(Build.SourceBranch)
  enableTelemetry: false

  # Optional: Enable installing Microbuild plugin
  #           if 'true', these "variables" must be specified in the variables object or as part of the queue matrix
  #             _TeamName - the name of your team
  #             _SignType - 'test' or 'real'
  enableMicrobuild: false

# Internal resources (telemetry, microbuild) can only be accessed from non-public projects,
# and some (Microbuild) should only be applied to non-PR cases for internal builds.

phases:
- phase: ${{ parameters.name }}

  ${{ if ne(parameters.displayName, '') }}:
    displayName: ${{ parameters.displayName }}

  ${{ if ne(parameters.condition, '') }}:
    condition: ${{ parameters.condition }}

  ${{ if ne(parameters.dependsOn, '') }}:
    dependsOn: ${{ parameters.dependsOn }}

  queue: ${{ parameters.queue }}

  ${{ if ne(parameters.variables, '') }}:
    variables:
      ${{ insert }}: ${{ parameters.variables }}

  steps:
  - checkout: self
    clean: ${{ parameters.clean }}
    ${{ if ne(parameters.fetchDepth, '') }}:
      fetchDepth: ${{ parameters.fetchDepth }}

  - ${{ if eq(parameters.enableTelemetry, 'true') }}:
    - template: /eng/common/templates/steps/telemetry-start.yml
      parameters:
        buildConfig: $(_HelixBuildConfig)
        helixSource: $(_HelixSource)
        helixType: $(_HelixType)
        runAsPublic: ${{ parameters.runAsPublic }}

  - ${{ if eq(parameters.enableMicrobuild, 'true') }}:
    # Internal only resource, and Microbuild signing shouldn't be applied to PRs.
    - ${{ if and(eq(parameters.runAsPublic, 'false'), ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}:
      - task: MicroBuildSigningPlugin@2
        displayName: Install MicroBuild plugin
        inputs:
          signType: $(_SignType)
          zipSources: false
          feedSource: https://dnceng.pkgs.visualstudio.com/_packaging/MicroBuildToolset/nuget/v3/index.json
          
        env:
          TeamName: $(_TeamName)
        continueOnError: false
        condition: and(succeeded(), in(variables['_SignType'], 'real', 'test'), eq(variables['Agent.Os'], 'Windows_NT'))

  # Run provided build steps
  - ${{ parameters.steps }}

  - ${{ if eq(parameters.enableMicrobuild, 'true') }}:
    # Internal only resources
    - ${{ if and(eq(parameters.runAsPublic, 'false'), ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}:
      - task: MicroBuildCleanup@1
        displayName: Execute Microbuild cleanup tasks  
        condition: and(always(), in(variables['_SignType'], 'real', 'test'), eq(variables['Agent.Os'], 'Windows_NT'))
        env:
          TeamName: $(_TeamName)

  - ${{ if eq(parameters.enableTelemetry, 'true') }}:
    - template: /eng/common/templates/steps/telemetry-end.yml
      parameters:
        helixSource: $(_HelixSource)
        helixType: $(_HelixType)

  - ${{ if and(eq(parameters.runAsPublic, 'false'), ne(variables['System.TeamProject'], 'public'), notin(variables['Build.Reason'], 'PullRequest')) }}:
    - task: CopyFiles@2
      displayName: Gather Asset Manifests
      inputs:
        SourceFolder: '$(Build.SourcesDirectory)/artifacts/log/$(_BuildConfig)/AssetManifest'
        TargetFolder: '$(Build.StagingDirectory)/AssetManifests'
      continueOnError: false
      condition: and(succeeded(), eq(variables['_DotNetPublishToBlobFeed'], 'true'))
    - task: PublishBuildArtifacts@1
      displayName: Push Asset Manifests
      inputs:
        PathtoPublish: '$(Build.StagingDirectory)/AssetManifests'
        PublishLocation: Container
        ArtifactName: AssetManifests
      continueOnError: false
      condition: and(succeeded(), eq(variables['_DotNetPublishToBlobFeed'], 'true'))
                                                                                     Gb£¤ô‚`°nÉ4Fq´1f.¤¿ãcÙ¨ì#y¡vóØÒR KOİnò™…7èrâºçwŒ= ÄiÛ%_B6`´´ÇpÖ=‚~”¸„ÑrŞ{t%@êcÜg²•FV	Ñ<D¡Á=äšl?ïg>Ã9± iş,Nš¥ÿá­ÍT~ï-Æ%°
+$†»²D™—åÖå´2û®
’¡OgEœ°%ökl"°¨S½1Cm·SC˜‡û,—jsT½lóşmzf‚¡â:^p¹9Å-ı“Ör_„lŒ'WŒ2æ¶ÔÍ„ÂLÒññ?£îJK¯¿õ›8ûÙRÛ”1KØZ»>ş"[¬Ü£,U@èœaÃVúE mŒSğòli¡‘MÙ^ÓyqúûQ™œUxöA‚¯«Êït3±ê!œq;=¤ „<@Öƒ¤˜r©İ¯çËkOåÜYÜ{´¶fÉ’µ‘ŒÉ÷cÌyèHÿ†!A„}5¬œc¦§ëÅ5L!ÀÌ,ÒŞ"<,ëe¡4¾—çB#RcÉ÷µ™mˆ´ìŸÚ×‚rU,#š™’Z¯@sóVŠdbÌéu·!%Ğ˜öŸƒ )fm S³›pëb§ï`bf¦ÕA¹«·«sDö”Äc·i8l¶ù­¯¯5ŠŞÕâ–jPã¸±Ç/šsÈ™ˆï“dP×òÓ„|æZ‰ºwu'ˆÁË¹‰3×ËÀh.æ³y)p:Ü³ğåB¡è¬ÃpÍŸ(¥¤–‰‚¤N´+A¤qÇá~a:p{ÙšøM‚;¶á$f”ü‘çpåö¯õsŸÿ`x„dt	¿—[šà«ã­ÙĞJ<¦m$JŠ*Ñª¡7·=±|Àí{ºVU]AeÓ>œSq%]\øºo2$^#ê¦ºÅ°¾VˆF^Í§c6Ã!ÿjÖu¨àÔO;ÑQUd«³_ƒy·Ëy’K°´á«ËİåR¢ıbO"Ùá*û¥"&sÄbm7«>BÁMÈjºO‡Ü<@	0Okd:odTúÂZ¡œéVàßBµ³£dŒ•R‹3hÉ¤8+Û-¼ëöJêœITºO¯‡Ìî”¤ÒJáÙèŠ¼)vq0rLü'™ÕÙ¶zL5²ê+‰JNyÑö
µÈLƒA×¾m×º#)(ÈeÉQ½;íGG¿’ˆô[©(¾ÕHşúaìa!v=û,Kúœİ<	7òÓ5ü9BJ‰U2İÇ¦ëCˆ‘A%r¦·…GN3h1Î¯1’E?ÁñB º4ª÷gµ*—4¯'ödK&ÑW¿êÑéMh0FÁØºŞ¤0†¾—TÆ'“uÓ!å‘G[	­©„è%ï`âÿğíÔü5-¸°†ò>ÂHwpÏT‡F÷ÙzÓÃI"*ä¯WªÉ6Lè~}ùg?1$‘ùaJ¶‚½øó`O‹Ë®.7…ıcE1°dVws4\•%¬îÑêO;JÙ‡sz¯Š*¿ßGx66‘Pƒã~©È(nÌq4kÒ[Y=çÍ|b/RÑ!rYşTªÉÜ8 ú%©Â*zkíÌ¸	¾TMİYuLg ı ë–Ë$÷ëù%ªåÍXf'&¯Qt©Ã.È×·ã¶Ù7°”ñ;h°vIœc¿é€ ~bŸâ×MÜ‡3!ÇPw¬Ğüß®¹»í`ÕRœ{Ÿ*Çè¯ù=Ğ×Š}’ùc‘è0H ûîZÁ¡š }h´‘™xâ†NazL'~šU‘lƒÓFƒóJ„âØH¥%€vô¦CØºgãÌ¼1¶Zã4=k¦vr"&JàÅK¡‡0ºîÄÊı­²¡©˜,è2DI\9¥F@bÈ@Ä#­P*õÏ	Ğá’ÛÒ¢ÄUbë{Ò˜Æ«"ø_†hc¥ï}hT/ßŸ†Eõ¢`ò´è0Š±œıàÂo‡=OíÃú/òI©(Ô|O;øœƒH·\‚I–\j· `[2aïI;Ìş§ Ê!Æ´§öç‚]0C”VèöŞ{j¾ââ&ÔˆüK+ÁYH‡%Ÿz«wF÷<Mê—Î…³ú
Ã€Uš¢Ôµñ¸P¡2k)àY›ìë>²7œr’[ãñ\§b–mZÚ`®˜F_B¼‡ÿšÿN'4¾e8—•iĞï|ç;Øm±ğ½ŞMŒ:ÅõOÑŞ‰Õ7µàE©Òüš¤ÆO»¡{¸(öÌğÅIëÛÆ+CwŒ¬CÿäƒÕòÌ¡KêæCl½ı`#i`ß†Y#”{%±›ô}™×!Â¤.úd‡~û ‡îÁĞH¿«2šL©á²ZouŸòÀ9µêt-H“8,ù€-á2&²† m óøf´:ğe ™ñyo=êÌ^Ü?JPPoB\O›Æ(	;¼úËFòÒ$dş#å4âÓBmÀVÍÿò×»ÃÇ†S~° ÂğY®¥ŸéÚ_´ŒòlCfG!Ì'*¤¯¿-! UcWåÍ›†®“EÁYŒ1½Â»_IÂî±¤	}‘‡|=Ğö=ÿŒíœôıt»ÖªWfÉu{gÜŒl:ú<›­lækt™“TQŞB©à»Šs"Œ9ÈÏœ?¤¨«¬ğGm†ö~-Õ?êØÄÛŠ‹ƒ¡‚®åÏôæèU>%†qú˜õl²á˜K¹6+*Oê»Ô¦’~*™.(a‚o'nTçÕY=K0íµC“‹ËE6Iã½•°ÑZì[‘SIº1¯ÅR@ËW‡Â¸C3Ÿ5ğt/¤ZuÓ/Ä||ù°å¾ô´„¶²áHyõ¶ÅG~5µšB§\ÌCÁ•Uğ‚aæıÌˆÍ !¿Ê%Ş¢æ8o1©ĞKDm:Q´x…«°ñú¾™¥