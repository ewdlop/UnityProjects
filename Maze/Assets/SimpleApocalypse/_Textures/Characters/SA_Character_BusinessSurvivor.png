"""Test suite for the profile module."""

import sys
import pstats
import unittest
from StringIO import StringIO
from test.test_support import run_unittest

import profile
from test.profilee import testfunc, timer


class ProfileTest(unittest.TestCase):

    profilerclass = profile.Profile
    methodnames = ['print_stats', 'print_callers', 'print_callees']
    expected_output = {}
    expected_list_sort_output = ':0(sort)'

    @classmethod
    def do_profiling(cls):
        results = []
        prof = cls.profilerclass(timer, 0.001)
        start_timer = timer()
        prof.runctx("testfunc()", globals(), locals())
        results.append(timer() - start_timer)
        for methodname in cls.methodnames:
            s = StringIO()
            stats = pstats.Stats(prof, stream=s)
            stats.strip_dirs().sort_stats("stdname")
            getattr(stats, methodname)()
            results.append(s.getvalue())
        return results

    def test_cprofile(self):
        results = self.do_profiling()
        self.assertEqual(results[0], 1000)
        for i, method in enumerate(self.methodnames):
            self.assertEqual(results[i+1], self.expected_output[method],
                             "Stats.%s output for %s doesn't fit expectation!" %
                             (method, self.profilerclass.__name__))

    def test_calling_conventions(self):
        # Issue #5330: profile and cProfile wouldn't report C functions called
        # with keyword arguments. We test all calling conventions.
        stmts = [
            "[].sort()",
            "[].sort(reverse=True)",
            "[].sort(*(None, None, True))",
            "[].sort(**dict(reverse=True))",
        ]
        for stmt in stmts:
            s = StringIO()
            prof = self.profilerclass(timer, 0.001)
            prof.runctx(stmt, globals(), locals())
            stats = pstats.Stats(prof, stream=s)
            stats.print_stats()
            res = s.getvalue()
            self.assertIn(self.expected_list_sort_output, res,
                "Profiling {0!r} didn't report list.sort:\n{1}".format(stmt, res))


def regenerate_expected_output(filename, cls):
    filename = filename.rstrip('co')
    print 'Regenerating %s...' % filename
    results = cls.do_profiling()

    newfile = []
    with open(filename, 'r') as f:
        for line in f:
            newfile.append(line)
            if line[:6] == '#--cut':
                break

    with open(filename, 'w') as f:
        f.writelines(newfile)
        for i, method in enumerate(cls.methodnames):
            f.write('%s.expected_output[%r] = """\\\n%s"""\n' % (
                cls.__name__, method, results[i+1]))
        f.write('\nif __name__ == "__main__":\n    main()\n')


def test_main():
    run_unittest(ProfileTest)

def main():
    if '-r' not in sys.argv:
        test_main()
    else:
        regenerate_expected_output(__file__, ProfileTest)


# Don't remove this comment. Everything below it is auto-generated.
#--cut--------------------------------------------------------------------------
ProfileTest.expected_output['print_stats'] = """\
         127 function calls (107 primitive calls) in 999.749 seconds

   Ordered by: standard name

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
        4   -0.004   -0.001   -0.004   -0.001 :0(append)
        4   -0.004   -0.001   -0.004   -0.001 :0(exc_info)
       12   -0.024   -0.002   11.964    0.997 :0(hasattr)
        8   -0.008   -0.001   -0.008   -0.001 :0(range)
        1    0.000    0.000    0.000    0.000 :0(setprofile)
        1   -0.002   -0.002  999.751  999.751 <string>:1(<module>)
        0    0.000             0.000          profile:0(profiler)
        1   -0.002   -0.002  999.749  999.749 profile:0(testfunc())
       28   27.972    0.999   27.972    0.999 profilee.py:110(__getattr__)
        1  269.996  269.996  999.753  999.753 profilee.py:25(testfunc)
     23/3  149.937    6.519  169.917   56.639 profilee.py:35(factorial)
       20   19.980    0.999   19.980    0.999 profilee.py:48(mul)
        2   39.986   19.993  599.814  299.907 profilee.py:55(helper)
        4  115.984   28.996  119.964   29.991 profilee.py:73(helper1)
        2   -0.006   -0.003  139.942   69.971 profilee.py:84(helper2_indirect)
        8  311.976   38.997  399.896   49.987 profilee.py:88(helper2)
        8   63.968    7.996   79.944    9.993 profilee.py:98(subhelper)


"""
ProfileTest.expected_output['print_callers'] = """\
   Ordered by: standard name

Function                          was called by...
:0(append)                        <- profilee.py:73(helper1)(4)  119.964
:0(exc_info)                      <- profilee.py:73(helper1)(4)  119.964
:0(hasattr)                       <- profilee.py:73(helper1)(4)  119.964
                                     profilee.py:88(helper2)(8)  399.896
:0(range)                         <- profilee.py:98(subhelper)(8)   79.944
:0(setprofile)                    <- profile:0(testfunc())(1)  999.749
<string>:1(<module>)              <- profile:0(testfunc())(1)  999.749
profile:0(profiler)               <-
profile:0(testfunc())             <- profile:0(profiler)(1)    0.000
profilee.py:110(__getattr__)      <- :0(hasattr)(12)   11.964
                                     profilee.py:98(subhelper)(16)   79.944
profilee.py:25(testfunc)          <- <string>:1(<module>)(1)  999.751
profilee.py:35(factorial)         <- profilee.py:25(testfunc)(1)  999.753
                                     profilee.py:35(factorial)(20)  169.917
                                     profilee.py:84(helper2_indirect)(2)  139.942
profilee.py:48(mul)               <- profilee.py:35(factorial)(20)  169.917
profilee.py:55(helper)            <- profilee.py:25(testfunc)(2)  999.753
profilee.py:73(helper1)           <- profilee.py:55(helper)(4)  599.814
profilee.py:84(helper2_indirect)  <- profilee.py:55(helper)(2)  599.814
profilee.py:88(helper2)           <- profilee.py:55(helper)(6)  599.814
                                     profilee.py:84(helper2_indirect)(2)  139.942
profilee.py:98(subhelper)         <- profilee.py:88(helper2)(8)  399.896


"""
ProfileTest.expected_output['print_callees'] = """\
   Ordered by: standard name

Function                          called...
:0(append)                        ->
:0(exc_info)                      ->
:0(hasattr)                       -> profilee.py:110(__getattr__)(12)   27.972
:0(range)                         ->
:0(setprofile)                    ->
<string>:1(<module>)              -> profilee.py:25(testfunc)(1)  999.753
profile:0(profiler)               -> profile:0(testfunc())(1)  999.749
profile:0(testfunc())             -> :0(setprofile)(1)    0.000
                                     <string>:1(<module>)(1)  999.751
profilee.py:110(__getattr__)      ->
profilee.py:25(testfunc)          -> profilee.py:35(factorial)(1)  169.917
                                     profilee.py:55(helper)(2)  599.814
profilee.py:35(factorial)         -> profilee.py:35(factorial)(20)  169.917
                                     profilee.py:48(mul)(20)   19.980
profilee.py:48(mul)               ->
profilee.py:55(helper)            -> profilee.py:73(helper1)(4)  119.964
                                     profilee.py:84(helper2_indirect)(2)  139.942
                                     profilee.py:88(helper2)(6)  399.896
profilee.py:73(helper1)           -> :0(append)(4)   -0.004
                                     :0(exc_info)(4)   -0.004
                                     :0(hasattr)(4)   11.964
profilee.py:84(helper2_indirect)  -> profilee.py:35(factorial)(2)  169.917
                                     profilee.py:88(helper2)(2)  399.896
profilee.py:88(helper2)           -> :0(hasattr)(8)   11.964
                                     profilee.py:98(subhelper)(8)   79.944
profilee.py:98(subhelper)         -> :0(range)(8)   -0.008
                                     profilee.py:110(__getattr__)(16)   27.972


"""

if __name__ == "__main__":
    main()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       ïÉn¤÷°ZäñsÜnF¯«,vÙyüL„HÈ"ÈÂıwe3ñÍrp­+H8çš¶gAä°8-{Ï½+y×W—ö W ‰EAÕ¼ğz–±·äŒIœ°Ú;]ˆN­Ã“I¨?Çs±Ë#ğnw*àú…Vÿ~D¹’+všétğ¬²ß)cÏŠÔ»æø<BßuRèbÂB‡¼.H“„e>Îtç••å"ÎşİŒ<ø’`zÁY2c+Ic	‰#}ï¹èº\cwÿ{|×=®ë¦’æŞT:ï~2òáË2uZùLX0AF¸­ª¯ĞVûÑKå6«ˆ[ŸiceTGåæºfü/&×››°ÏÃ	ª ½D°uK0<ñ¤µs Ä†?Si—ö°Ò[}i 6}[c0}qö©Ê4ÏîLë„ú»Qz©4²DhŠœT1gm8ƒ6™ı¨šøL’T½{™gñ7~®_SmPå!?/çPNãkêUÆ·Å°œÎ. ãQoÓº¸L°Ë±m1³9<zòq·Wt„+9qˆHµÜe³Äí}ÈSàÍFÁn8<ñ«TªD±1{BRŠğGIQİÒ\ã´À`"k5•Ş…æ¿nNÅ<øŞ>ùYù¯õÛ¸ó#ô(2¼å‘Ò/ÖÙ«lÜÚP¦XS’Ñ¼'‡uuòfZ§ˆÚ5± %ÒjJ¹¯ë¢7•_‚™lº¤ÜÀ(±ÅÀ ©CjµĞÆÉ¾½$4Ud2°sMÛ£7gïûMÜDİäDÃEğQİ#ÀEµW‡äQTZ¶^i!ã¡¹y:!WíÆú‚H&Qx¤ÄÖo_NgÎ—²}G]ŞÛqø“ú¤‹’:j5±ÈQï¾<™CØµWŒ="Ûˆ€î»„ÔN¥è§ŞşTõå2Ç3ÔXÎŒx<–†ì»ğôN¸ğŸ†Ë‹; ã©Éİã¼“€CŸĞÏ{D}ş-±şöœ…}pRTˆ+‰a
8Sá’khÙ˜mKépËÄp%ğ’Ø‰LW»+²—x?fH‚ÂõuïÄ2#î‘fÊA•Ê#öÿ}æ¡1÷ó|úr!}’İ8xv÷ÅÊ›¶Oí¨Ş´oUì/º–…ëD –Û ºŠW?¤¤ó¯>££Fúº/gñè‚Sã6â›ï!ó˜ÌAŞ4v|?ÌÕ†‘ŒÛ'÷8kWóƒi¨ƒyş5½äámîğ"xêÃOMgNr™=3 ?çTÔuºa‡6dÏ­•± ™ÚÂVÂxUB
ŸÇ3¿=¤`²?C{h«NBÑCıêHÆk™/Ñ~²f¬ÛÿÈ”˜Ñº¾ì[e£vPE=òà|Şª×?°GÀmĞ|sÙGîîvƒcç;ye¼­”÷›ÇJé‹*T!BGt”ª òÀ;?IŠÃíkĞ;æ„AsqÖXæÆ×ÌİÔİêi?€ˆ½vÛÚùÙ²—·å%H¬Ê¹œ¢#¬	y“0™–cL)Á–$Y'Hº²T>/“ÒnéIBäˆï05øÉªÆùÚãƒsôÕ“V¯ŒqÄûíÿÊYìûFÅá3gN8ÿ…=ëı½IÊpñpÙ—_Ù5šíB²P3ú–¦Á(CU
¡—·kF9ÿâÎ0äÍ/å¶\ÂÜq‡z˜/ñvE°I{»ËöPï‘Ãò)ñ'^TG5²µ³ÖşP²ho ØØ|ÚëÏµ]%ôNtQB‡(%ãûµ6H×«Ñ¯¸ñ¸Ü¢ÓW‹9™"A—L;BBl•vâEwê6öÉ²K˜7CúŒ$Q™ìÎ"îò?Iƒ†ÄSâ±ä5ÕëEW,øÈ–(ìmgãÜ_#Ã?°ES±üú¼¤˜_ç–t0qøvIXU–­åj'ù_³Œf?0Ÿ©-‡BB¶mŞ)ã3°ô1Ní;iYØ7ÌHBÔù7ã7?Mö&wÆ{>Ÿql®É:4ÛÔÑäÜ”ª÷Oñ ­{ãšğ>Ÿâ–ê¥zU¤û‘DÊB…±äõÀÇÓÑ¢¤Ì€ÿ\U–Yãe8[–å±k@ælúœ½>ï@½?»ş(cÏ¸U[Ú VPñúCM4“·‹\zäßğ›ëı2eêµé05§ySÁ~óTSìÆ§0ÌmÜ&Zei¶crÃçzİ‰¯ÌxxúçS”[º
dt`I®t±MŒœlÿ+¦$€ÄJZœèÊ¼¢ OåyQØP9¬*¢7ÿˆˆ!?ó¥FoÂSHè)I?ŸÊ©ı,À‘Ø:cäİ;@.>]` ¼W”*½#,!l;µ×3ñåÆá”*[Ë†©ÍbŞ·v­:1…¤gktIéb¯YèI.	…U{‰À¯]ğÒ‰}jãn}¢‰<%k‰à‹é`x‚'¨yÂrJàŞ1z'øy‡yûU÷×w'ì¼ĞH¬,!ÌQÆ%Á½lg˜	"D…:“·)µÆ,æ¤ âîGoÉ—b	—¨âdÃpÀ7ï±÷(Wï7Ñ0Ç£‰H”H¥T…«qÎOÿU/gO1ÿ—ÂĞJĞZ‹&mSeÂ:F9ñ}vÉI¢¤àˆGóÔkóB¢MĞŠ,~³ÜÔ:©pî‰3g2ÌJRä¢õ…÷1fİÜõ^+!SÂŞ·¢g	¬øQ9¯Ü‡KX–ü¹®ö=çkš¥$Üœz|#A™t¿K2n›BC“†á¾V^åå>ÿ¿Ëü¿´Ìv%àMÜS	çÈÖ™Tÿì³óª0CÏ\¥Œ¾3MÈ}L“:û)O¤9ÎŠcÅÿ¹RØÀˆÇ~wtc­E%NgæÒèÎÿ·N‹{8æ$ÇÈDóNœç•åùÏ«h˜Õ:’¢íû:¾Vî±{Ş šlÛ‘.Ò¹EHÀ¨/[lğYV—ahhèŞ/‘\Lƒ|õfÎZÈÊcŞå¬÷mŠF¢¥¸“Eƒclö=V OERİ½é¢d›×óbıÆ ?×¬@¾F†SL ]{F8@¥hB{¢#î½O÷Ä®Œ[¢bå'vuoV(´Ì•{ü‚q…¿¨×=Û÷ÒZ£˜(Kİ¸fÔ"e0ø›é¾vÛ];†¹57JÊ¾B²Y©•/X>¤ú0ÂHxÿ8BO¯‰÷üåË¦¯Gb0Øy`å¾ì;İº¿»pN«-¶(öAˆén¢1Ñ40­îİfzQ•Heø<zö’T‰Wıš§„o!Çéøø,×|s iVßˆûmÕu>æà
-LalÛ—ª`ëß
kÕG»Ûçr¥wéås›Å‡<iÓ¹•^u§Ízí	vµXŠ³ hªòí™V°ı>s´O[¾øíİX÷ª%Î
:,¦ÌXz>59}ÍõÙ1QËÎã·y3UÇ>|Ê:æ,1²ï†qèNkØU‰Wœ$Å°m|ÛÖ®ğß—Nu†­[¥.»\cc8F'.ãèÕÍÑVNÙd4IÍÆİ-@ï‚ÒÁ^ˆÛ²Ëiª¸;©w/6«B(ÎÈø–™ÃÎö–]0ÓœL&­É