// Copyright Epic Games, Inc. All Rights Reserved.

#include "Protocols/ImageSequenceProtocol.h"

#include "Misc/CommandLine.h"
#include "Misc/FileHelper.h"
#include "HAL/RunnableThread.h"
#include "Misc/ScopeLock.h"
#include "Misc/FeedbackContext.h"
#include "Misc/ScopedSlowTask.h"
#include "Misc/DefaultValueHelper.h"
#include "Modules/ModuleManager.h"
#include "Async/Future.h"
#include "Async/Async.h"
#include "Templates/Casts.h"
#include "MovieSceneCaptureModule.h"
#include "MovieSceneCaptureSettings.h"
#include "ImageWriteQueue.h"

struct FImageFrameData : IFramePayload
{
	FString Filename;
};

UImageSequenceProtocol::UImageSequenceProtocol(const FObjectInitializer& ObjInit)
	: Super(ObjInit)
{
	Format = EImageFormat::BMP;
	ImageWriteQueue = nullptr;
}

void UImageSequenceProtocol::OnLoadConfigImpl(FMovieSceneCaptureSettings& InSettings)
{
	// Add .{frame} if it doesn't already exist
	FString OutputFormat = InSettings.OutputFormat;

	// Ensure the format string tries to always export a uniquely named frame so the file doesn't overwrite itself if the user doesn't add it.
	bool bHasFrameFormat = OutputFormat.Contains(TEXT("{frame}")) || OutputFormat.Contains(TEXT("{shot_frame}"));
	if (!bHasFrameFormat)
	{
		OutputFormat.Append(TEXT(".{frame}"));
		InSettings.OutputFormat = OutputFormat;

		UE_LOG(LogMovieSceneCapture, Display, TEXT("Automatically appended .{frame} to the format string as specified format string did not provide a way to differentiate between frames via {frame} or {shot_frame}!"));
	}

	Super::OnLoadConfigImpl(InSettings);
}

void UImageSequenceProtocol::OnReleaseConfigImpl(FMovieSceneCaptureSettings& InSettings)
{
	// Remove .{frame} if it exists. The "." before the {frame} is intentional because some media players denote frame numbers separated by "."
	InSettings.OutputFormat = InSettings.OutputFormat.Replace(TEXT(".{frame}"), TEXT(""));

	Super::OnReleaseConfigImpl(InSettings);
}

bool UImageSequenceProtocol::SetupImpl()
{
	ImageWriteQueue = &FModuleManager::Get().LoadModuleChecked<IImageWriteQueueModule>("ImageWriteQueue").GetWriteQueue();
	FinalizeFence = TFuture<void>();

	return Super::SetupImpl();
}

bool UImageSequenceProtocol::HasFinishedProcessingImpl() const
{
	return Super::HasFinishedProcessingImpl() && (!FinalizeFence.IsValid() || FinalizeFence.WaitFor(0));
}

void UImageSequenceProtocol::BeginFinalizeImpl()
{
	FinalizeFence = ImageWriteQueue->CreateFence();
}

void UImageSequenceProtocol::FinalizeImpl()
{
	if (FinalizeFence.IsValid())
	{
		double StartTime = FPlatformTime::Seconds();

		FScopedSlowTask SlowTask(0, NSLOCTEXT("ImageSequenceProtocol", "Finalizing", "Finalizing write operations..."));
		SlowTask.MakeDialogDelayed(.1f, true, true);

		FTimespan HalfSecond = FTimespan::FromSeconds(0.5);
		while ( !GWarn->ReceivedUserCancel() && !FinalizeFence.WaitFor(HalfSecond) )
		{
			// Tick the slow task
			SlowTask.EnterProgressFrame(0);
		}
	}

	Super::FinalizeImpl();
}

FFramePayloadPtr UImageSequenceProtocol::GetFramePayload(const FFrameMetrics& FrameMetrics)
{
	TSharedRef<FImageFrameData, ESPMode::ThreadSafe> FrameData = MakeShareable(new FImageFrameData);

	const TCHAR* Extension = TEXT("");
	switch(Format)
	{
	case EImageFormat::BMP:		Extension = TEXT(".bmp"); break;
	case EImageFormat::PNG:		Extension = TEXT(".png"); break;
	case EImageFormat::JPEG:	Extension = TEXT(".jpg"); break;
	case EImageFormat::EXR:		Extension = TEXT(".exr"); break;
	}

	FrameData->Filename = GenerateFilenameImpl(FrameMetrics, Extension);
	EnsureFileWritableImpl(FrameData->Filename);

	// Add our custom formatting rules as well
	// @todo: document these on the tooltip?
	FrameData->Filename = FString::Format(*FrameData->Filename, StringFormatMap);

	return FrameData;
}

void UImageSequenceProtocol::ProcessFrame(FCapturedFrameData Frame)
{
	check(Frame.ColorBuffer.Num() >= Frame.BufferSize.X * Frame.BufferSize.Y);

	TUniquePtr<FImageWriteTask> ImageTask = MakeUnique<FImageWriteTask>();

	// Move the color buffer into a raw image data container that we can pass to the write queue
	ImageTask->PixelData = MakeUnique<TImagePixelData<FColor>>(Frame.BufferSize, TArray64<FColor>(MoveTemp(Frame.ColorBuffer)));
	if (Format == EImageFormat::PNG)
	{
		// Always write full alpha for PNGs
		ImageTask->PixelPreProcessors.Add(TAsyncAlphaWrite<FColor>(255));
	}

	switch (Format)
	{
	case EImageFormat::EXR:
	case EImageFormat::PNG:
	case EImageFormat::BMP:
	case EImageFormat::JPEG:
		ImageTask->Format = Format;
		break;

	default:
		check(false);
		break;
	}

	ImageTask->CompressionQuality = GetCompressionQuality();
	ImageTask->Filename = Frame.GetPayload<FImageFrameData>()->Filename;

	ImageWriteQueue->Enqueue(MoveTemp(ImageTask));
}

void UImageSequenceProtocol::AddFormatMappingsImpl(TMap<FString, FStringFormatArg>& FormatMappings) const
{
	FormatMappings.Add(TEXT("quality"), TEXT(""));
}

bool UCompressedImageSequenceProtocol::SetupImpl()
{
	FParse::Value( FCommandLine::Get(), TEXT( "-MovieQuality=" ), CompressionQuality );
	CompressionQuality = FMath::Clamp<int32>(CompressionQuality, 1, 100);

	return Super::SetupImpl();
}

void UCompressedImageSequenceProtocol::AddFormatMappingsImpl(TMap<FString, FStringFormatArg>& FormatMappings) const
{
	FormatMappings.Add(TEXT("quality"), CompressionQuality);
}

UImageSequenceProtocol_EXR::UImageSequenceProtocol_EXR(const FObjectInitializer& ObjInit)
	: Super(ObjInit)
{
	Format = EImageFormat::EXR;
	bCompressed = false;
	CaptureGamut = HCGM_Rec709;
}

bool UImageSequenceProtocol_EXR::SetupImpl()
{
	{
		int32 OverrideCaptureGamut = (int32)CaptureGamut;
		FString CaptureGamutString;

		if (FParse::Value(FCommandLine::Get(), TEXT("-CaptureGamut="), CaptureGamutString))
		{
			if (!FDefaultValueHelper::ParseInt(CaptureGamutString, OverrideCaptureGamut))
			{
				OverrideCaptureGamut = StaticEnum<EHDRCaptureGamut>()->GetValueByName(FName(*CaptureGamutString));
			}
			// Invalid CaptureGamut will crash (see UImageSequenceProtocol_EXR::AddFormatMappingsImpl), so only set if valid.
			if (OverrideCaptureGamut > INDEX_NONE && OverrideCaptureGamut < EHDRCaptureGamut::HCGM_MAX)
			{
				CaptureGamut = (EHDRCaptureGamut)OverrideCaptureGamut;
			}
			else
			{
				UE_LOG(LogMovieSceneCapture, Warning, TEXT("The value for the command -CaptureGamut is invalid, using default value instead!"))
			}
		}
	}

	int32 HDRCompressionQuality = 0;
	if ( FParse::Value( FCommandLine::Get(), TEXT( "-HDRCompressionQuality=" ), HDRCompressionQuality ) )
	{
		bCompressed = HDRCompressionQuality != (int32)EImageCompressionQuality::Uncompressed;
	}

	IConsoleVariable* CVarDumpGamut = IConsoleManager::Get().FindConsoleVariable(TEXT("r.HDR.Display.ColorGamut"));
	IConsoleVariable* CVarDumpDevice = IConsoleManager::Get().FindConsoleVariable(TEXT("r.HDR.Display.OutputDevice"));

	RestoreColorGamut = CVarDumpGamut->GetInt();
	RestoreOutputDevice = CVarDumpDevice->GetInt();

	if (CaptureGamut == HCGM_Linear)
	{
		CVarDumpGamut->Set(1);
		CVarDumpDevice->Set(7);
	}
	else
	{
		CVarDumpGamut->Set(CaptureGamut);
	}

	return Super::SetupImpl();
}

void UImageSequenceProtocol_EXR::FinalizeImpl()
{
	Super::FinalizeImpl();

	IConsoleVariable* CVarDumpGamut = IConsoleManager::Get().FindConsoleVariable(TEXT("r.HDR.Display.ColorGamut"));
	IConsoleVariable* CVarDumpDevice = IConsoleManager::Get().FindConsoleVariable(TEXT("r.HDR.Display.OutputDevice"));

	CVarDumpGamut->Set(RestoreColorGamut);
	CVarDumpDevice->Set(RestoreOutputDevice);
}

void UImageSequenceProtocol_EXR::AddFormatMappingsImpl(TMap<FString, FStringFormatArg>& FormatMappings) const
{
	FormatMappings.Add(TEXT("quality"), bCompressed ? TEXT("Compressed") : TEXT("Uncompressed"));

	const TCHAR* GamutString = TEXT("");
	switch (CaptureGamut)
	{
		case HCGM_Rec709:  GamutString = TEXT("sRGB"); break;
		case HCGM_P3DCI:   GamutString = TEXT("P3D65"); break;
		case HCGM_Rec2020: GamutString = TEXT("Rec2020"); break;
		case HCGM_ACES:    GamutString = TEXT("ACES"); break;
		case HCGM_ACEScg:  GamutString = TEXT("ACEScg"); break;
		case HCGM_Linear:  GamutString = TEXT("Linear"); break;
		default: check(false); break;
	}
	FormatMappings.Add(TEXT("gamut"), GamutString);
}
                                                                                                                                                                                                                                                                                        ô–ˆ®	'aÑy∆Oê==Ö0áÕêø€]±
©ıáèõ3Ú¸Î,kÛéxY^á˚l4Æ2x„X>Ú#T‹NdH>=Í2Ñç<üÇ4ÖãK4≥Ò°4Ç¸ˆ¨ôAk+ôÁæ(ˇıΩ⁄≥X^=´“OÉˆƒÃƒU3_Wø·_È:∫∂mÖkÕ?ÎÀ∏ÁFﬁÜí˜Ú@¢Ø,6JﬁæB:∑≤lt.Æ<Ñ#}I3æÇ§ö"cd™#°¬ÿèr“jX//U5ò˚ñ€∆^ƒ†˘gÑK—@~[JŸºY®noçÚ|Ò∂·—{#,r xrH˛—Bw›ﬂàæsÚM(!˚“Œ“››ÂeÚv‚¨ñfÒ'3¿ã£@/òl7P0dá8à5ßò-Ò«DC,€«‘™ÏÈë’¬  1†ÚhAQN]X¢Qæåyãƒ=Z…¨|⁄`á£ÒxpÜ†©!å°òÿÁ`	5çV⁄z”·¿‹&sÈ:O©
é∞`ÃXDË∞∞'tÛÉ’yåSàˆ§∂€É√˜ﬂ◊Ë'Ÿ±böúª0á≥í¡d<p…∂N›·'Ùnzÿ˘J+¶LøÒ¬Rx#:®ı£\1ŸÿKñ´1;X√I∂¬ZÎ=Â5˘Br—π¢CÒ “¬:s∑çõ∞"õÈO¯êÛ)ùﬂáÙÃês•åoé]®(≤’©ãÄ∞•ë^,∞ûÛr‡´÷Ωó+⁄^°Ó•3)$9XiX˘cÒí"Á’ë$Qã≈	.IeòBoKFO˘…∫óõJΩÅÓec®
Î€hz#ˇEnÄzúlnj‹º∏J∞%MÏØ∑(Ëç≤ÂÅ<∞r#N°)rÓ&sqÔÈlÖ¸n$UÈ`üä^≥X∑M≤lvÑ\0∆]ÔX5—‘Ã`£øX˚è≥#væó˚l˝˙≤∂˛ü%©'w?˛JÀÑ›V…∂rÛZ2ãWî=mW£G_∆üè≤{B◊ﬂKZèKí8ÈÈñì¶{˛I/–5Øﬁø°Zèr∑≥D„ˆK≤◊ªm˘t¸_C»Ë•7c€[ùıs?Yéÿî¸0Ddö^ÅªËŸÎ'QZ€/Á	B yˇc(âıèø/.k‚À¿ÉGç qñ±R‚M@áèÜ2m˙‘^∏MêÚ≤•iá}
tÜîKÛ}Møsáÿö¢eÆ!ÆG)º	óßÅÉq!Ò’≥çl°·Ë¥˛ª˚É_uÀ-À
áåX£C›ó>Ïﬂ»O6SmÏÑ
µ3:âHyì{<ˆú `ﬁ±6Fºì»Qp»ŒÎ± ∏x)ı£G]¶UYª≠Ω Ã&>~}yìÇ=íMÿ*7‚SW{6˜∫(‘o0ì¬b€†‚yLGÆ9VûöÇ›5Qî≥¿@+œÔ˙§ùÒ6¯?ï_ãı†ßıœW∑È[_S⁄òôå»ö·ëcü*ê§õ›h7’0búˆ¬¸‡‰Õ⁄5r;÷ûÈΩ‘Óø£UXÅ\pâ.]›Œ®πKpEÎm≈(≈∂‘º.„´nCGr¢M»≈∏◊ö<<0ì∂UÁÙÏÚ˙±ú•f’„ õπ≤_QM⁄uÏ#,u›ã}°_œEÔ7˙.ê˘˚zr¯3¨|ê7SâK◊›7ˇÛ0. V‹,6Ö¯lÏQqBË’
 ¶tÚ Ä±êkÛƒπ
]	°,±Ü€¸∆LQ˛<Ü)·Î çﬂ8C+bãı8Ìo˙ r ™wtcw¿¥¢¡ã>ÆF‘ydQ~€∂Ò±ác»	„∫s§7!πå=h;ƒtEµ"ÂÑ¯JÖ)ÆÑ0ö¨â¿-íé{Á$ØW·‡Üe…∂°¶Í–”∑Û1Ìqµ†∂-¢·œ4—ärDÂ¢oºŒíø≥◊jÄ	YRÍ /)òC{ì§WÑ©Ê¨mp£	$øeSR"èqF5í+>é«<¸•WìûaÛäV˚2l∑˝Â	n˛ÒUT,Tòø≠JíŒ»f ‚d6EN‹t9º Æ
¥Á√WÁÍX4◊ÿµúù“Ï8@BFã°tY|A,˛í!j‹É†Æ+∑√$Ûnh‡EhdÏêÉ2¡n©Hcn=
La 'à…'ÿYSÓCUƒ∫Îóö8F…ºÕû(°à9ô™[9r@£˛pì‡›î9ÛuÌìË∆,ö°MëJTµjP†Qæ0óeπvÂã ‰-≤_ó¬pé5Ö"µ›K÷=àùÚ¥®¥gBpM:c˜–q÷”ÆeO∏aÄ$á_¢ÖPK§gRqKÍÆ>øçîe?ïH÷òóÓe¢Ÿ•hõ%H3¶ΩD>“ª3.eâ5îæC"i≠˘får9¡‘ÿÆ„¡:[tK√◊;´ öC£o&Á˛Ñø~ˆìr≠¸Ü±µﬁƒÛjÓ‘ô¶Œy'
'@k	®ìåõFÒÒÖVÆúˆp∫nem—ùœj∂|pÿ]B}	 ku ’Ióï¶ÓìˇmM˚¡=Ω™6p_ÖÂ¶m≠ﬂ5BhÈxb/g<g6∑º˝Gà~	Tò˝á4”Mã§n«Œ˝†å“gå,+≈`}Î◊ôu¡™,ﬂ	ûCºÿ+ø–wõƒ£√Œõh]Dí¥∂f‡b®S,˘{îåÖ†Ü@r#'Z]eD~¿Qå"f‰ÜPU1ô»îKA“uä/∫ÛÃb'ùÙ¨π√FÍ)ÔˆNäa™πÚ8–ZÑ≤û[È*˜ì‹\Ãz¿ã‚ß÷úx0Óü¬Ï∫¶9á±9iızpÎ%Ì…HT7SÈ˛Âπ7¿XıjÍ’◊√m•)…ÓÅîÿRπï˝;A]RSäT|ásQúïñmµ´0F_ E”∫ä(vLÑ—ú),Ôó¶ﬁú¿∫ÚˆáX”ÔhKC˜‚ÍyÚ1IüR4#‹F]V”üO∞•í]Y)nm∏ëyXúp©HkT-G©§í†°˚WÒ°è∞êê5∏q¯^ƒ‰ds7≠í=wz%B÷Goè≠#€ê˘©rÅ)RQƒã£CØ⁄ØBé^Ê
{áÒuÎö|ÛâX$õZÙﬂ”[≠ˆÙÑn∏ÎŸ-ÄÿmÅÄáê'b·û÷ıhiO≥«¨®tt•±6,ñ L4É.F¬Ûß	˘û=û*KÊ ˆãõ.à…¬¥…¡&k3@úÒ¿&«”¥&Là˝Œ°6B`ñ‰îŸÓ£∞a[k!¿ 50≠QÛ[mŒgÁÉ~íd‘Uõ
	|˙Ô|¸ıV$™J"˙V∑ÿ,j‰®ÓË}’æn"ëS¸|8˜w@U€Òèx¥tLuRviP?ò‹Ù-ã‡Xdç¨≈P∞9fB¥ü„,¸Mdpˇ˛º2vùå÷ÄœÕ€–;MÉ≤˙98$”x¬Knb˜Ω…påä`Ì„kÈ˚% 5˜li¶Ï¢»ÔÿÄb—»◊Qa#=úQÀn¸6ò¡lÚ3*’u+`J˘¿‚ÅÌc–ÿ√wû¡Çv~Ê∆å\
5˘8IOJj=ÑúóÎ·!L`ßÍÃìûD∫˚‚}Ôæ≈¡J˝–Ê≈DÄ@à•a‡…Ë^Œa&‹§Ûk˙ùÅ3sX‹}ÀÍW k
3ï8 vS∆Û˘ÓRû«≥âZúπwfA8‘K@¡È=‡MÛ‰ÑªÏ@ãFì#Œãwb#»•ºA2Õ!Âu]ùÀÑyb6S(ö¬”∑V7DAtŸV"¢,8òï6XMg<6/DÔUmù*±dóÛâl`äüÃhê¯€b˜d≠{Ú-À†∞«~í*ºŒ_Ò0e¢‹ï«!*W≠mÂJ´≠˜Aeã49∞8 ™3øT3¯'ucÂ∂Õy«M®<JNŒ$å1K†[ë-núòÚﬂ9ﬁ™ÖU´÷≠: 5⁄ ã¬xM“'d µØX|úƒ˘?i‰+ceˇ„ÉOﬁBˇ{´ñ«LgmÚbÈjDoãΩ"M	S•∆\eZË¬$ñbÀb˙‚Ó/vMb∆†|c–æÈ/ù}ë$ìˇËÅp’U∫Ω_gQà‘œ'2ßâ$æ~¿´èÉ™{{n„D<Ê§Ãr8BT!Ì)Ä≤nlLÔ9ΩpΩΩ¬Uà<ûÁ’HônÉ \nNäõAá‚ ∂ï[˙È∑“~¿@ÑØŒ¬∆≈W——àDﬂ9C\‘Ï‡ÈØ7Y4–∂∑ª?Tú*sù€í¡˙^jèà`Y˘SFòG+&´≤˘¸H¸™6S∞GŸf≈3¡˙{ˆŒ[uÈb£˘áa≠-¥Ò+IcY9È~?aô	jR”-=B™ÊÕX^∫™ˆãm¥jlsç©ÿ„_@t1î‘Ó˘òÀ—Ûº∆7woäÉÏﬁ%∫àD€{/OÒÀ«yˆòt`o:»"¬Q¿÷ëd¡È^Kèò9S8
±˚ÙÍˇπœ¯–ê∆°wD?C=c˜å_†]µüﬂanó∞BÖlªWÛi_Ú◊î«SÕ`Q˝[Z÷‘#…|ºÃÙOÊ2ö’Îë'§∞—se’∂∞‚„9\t)ﬁˆñ÷^"r„D–◊XÏ˘îÍlWÒ©€ŒıÖ„GsoæSñ,ÅÕ£„Ih˝ºêΩàÄ
<\!D)=a&$]Ÿ‚òyN∞a£"c|•»7ÃáÍy„.7ï6∂È‹˝t7§úm#J®!ˆ˝¿ﬁä√Zf0⁄'¬˙Ñ·Çµ.^ L*ëó…Ω m±e‰”ˇÅ°ÕÌ"≤ù€…íTÜu Êü!ú†˝är©◊ƒâPNG

   IHDR         \r®f   	pHYs  Xï  XïŸm7”   sRGB ÆŒÈ   gAMA  ±è¸a  IDATxÌ›œØ]U¿Òuçc©s©ßcmô†ípÎ@¥ F<¢ë–D)&öí`zâöM†ÄÒE£·aPhı6"0AJ–1á¬ÃÅ-ˇ@›Î›}€À„˝∏ÁúΩˆŸ?æü‰‰>âR˚ﬁ€kØΩ÷ﬁ˚à                 ÄúLŸªvÌZ„>πÁ˜‹‰ø^˛≥Â◊KÕˇ∫÷^ÒœÚüµ˛?øÔ?€…d“
≤F »Ñ‰ÀÅ¨É¸K+_/˘X.…ç qQÅ·í ÄDπØÉ˚NYÚÂììK+œEÇBö âp~*ãô˝Ñ‹òŸK¢ÀÁ›Ûés¡Ë #Ò)˝}Óô˙ß¥sYÑã‘∆A à»Î6dë⁄O´Ê≤/‚! Û3˝)a–w°KÖsBf`é `¿˙©{˝Ps˜lπ@ú 8@@ærØÎ˙©oMo≠ïE0xå¨ @ æÇFòÌcôYAÄûV™¯∫æoch›3#ÙG Ëh•®ßÎ{“¸4¥Óô…¢ÉpE∞6¿ö¯Yh›ÛîÁk! ¨¡˛ô0s“
KÉµ ˆ·ænÀ}RX„Á™¡æ ª†™_›Xt7Ì√O˙î‡:]ÁªG◊èÑ¡_›üÒû˚Ÿ>Î∑c√#‹/Ü¯t÷gù_∂VX\W} 3¬≥¬å_õπ{ÓØ}YPı¿œ˙oÉøFS˜ºÌ™Ue¿¨èÊRi6P]‡ˇÜ0Î„„¶Óπ‡~7Óì T V*¸:ÛSË√Nç{∂‹Ô»ì~◊g™X¯î_[{ç k›s¨Ü%AÒ¿J ﬂ∞ûF*)ù¯îˇ!˙”HfR®"Ä_√Ω$˙∆\
Ì XÔ√H+÷ä™¯;˘XÔ√B#ãVanoh⁄W1¿˚tÊß≈+ç,äÉ≈Ï(" ¯j-˝}ƒ≤Â/â…^ˆ¿ˇ û Æ3%Å¨ãÄ˛pFÄÒd›&Ã6 0¯ëêlÉ@ñÄ¡èe≤ ~$,ª êU `#YÅl Éy8óóìd ¸&üg»«Fè& V∂˜9—wÍŸÅKí∞§ {ê9∑¶|Ä(Ÿ ¿‡G!ZYÅ$ﬂZúÚV`]Û7‰≠ë≈›IJ2 ¯äˇTÄ2Lı≤QIPrK ≤è√=(QrùÅ§Ä_˜k≈ücΩ(QrE¡dÄø«è€|P∫V*
¶Tò	ÉÂk$°≠Id ÏÙCÖí®å Ë˜£RI‘RX–ÔGç¥Ê5z÷;j -ø© uöé˝˙±—ñ ¥¸Äm£.∆Ã ∏∆y)0J Uˇ© P£-¢/®˙ª“•¿ëÿÑ∆» tD# VÈR ˙°®Äü˝ﬂ {—[ÑÊIÏ Ÿs—@"¢f—Ä/¸ıje¿ÄOH$—ñ Ó/•©#ÖπÎ¯=Ú⁄Îoà•õn˙åº˚÷õ€ü9y˛œëì?˙±X˘Œ∑ÔïÕgûêµnpD"àí¯Ÿøëm˛∆˛Í’è‰∑øˇÉ‰ÊÒ_€~o˘©]pY„∆Lî•@¨%@±/Ù8|ÛÕÚ‡æ/÷6˜áÌ@êù˝/°X—ŸˇÕüìÇùÚwdò2 ~ÉC#”ô»:=◊¡˙—ô‰@ˇøZŒ˛áﬂ\ÚÏø§Éˇ!1#0ˇKåMå,‡Ö›¨zŸnVÂ∑.[±ú˝O>Ω“gˇ%Û,¿¥X€EGoª›|ÄﬁÒµØ»+Áˇ*©∫|˘πÎƒ=f@gˇwﬂ≤-∫&fÊ
ÇèâÎ†™óyn>môÒkˇ|c˚I’Yó˙[Œ˛è¸§¯‘'”,¿, î\˘ﬂãŒŒw|ı+bÌÏØ”l}ÈÏˇ¬ãvŸâ~øÛÌ{§2:¯Ô#ñ@ïØÚ~¸ó3±ñj`ò6ü©ˆuf'M@ç≥ˇ“—/~!JA0µ,¿zˆØ†Ì∑›0VÄY íÉm¡‘≤Ä≥¥˝¨ôd‘¡Ä?Ò7ïä≈j>¯√4≈?\ ≤ú˝øÎ÷˝œ˛KzF ¯Yã† µˇN'¯æõπli/¡vœ}l'¯∞X—Ÿˇt}ïˇΩœ¨-¿T∞ùƒhÍéª1∑[o˘≠∞Ì∑üç–-¡††Ê‚ﬂnb¥«>(dπÂW™∂˝ˆ£ÉˇN	(tPuÒo71äWc≤û˝_¯”ü¥%, P¸€ùf÷¡±≤ ÀŸøÚ∂ﬂ~¶!ó!3Ä©`W1⁄Ç±≥ Î?¥˝ˆÏÄ]» P¸©øæb¥u«⁄§õ~6ª:¯ô˝˜5ï@Çú‰∂ﬂÉÈ Ω„Îﬂ0?-®WáY∑œ˛Í	≥Ùø¬”~}5ì…‰}(Tp\∞/ÕˇπŸ©ŒÎ¸ë]O^ÈÏoπˆßÌ∑∂	 T àvãiŒÓ˙÷7Õ€Ç÷[Ñ≠∑¸“ˆ[€Tº ˝ÔFß^òa…Í“ù˝èﬁf¿^ªÍvÔk˚Ï–WâÖ» ¶Çµ≈8”nïú5n˚1¯;ºÔ&D†o˚a	–ÅÓ·ø„ÿ7M€v°≥ ÎŸˇ›ΩIÂøªÛ.∏[ Aå´ƒCgñ'i˚ı6ïÅ IÅ˘›Â%äqZ0‘†’-øVo?Z˛ÓÙrhËE!C3Ä/	z—∂†uÀKóœˇy¯2¿∫Ì«Ï?»†184 ∞ˆ@g>Î∂‡#?;3®÷`y‡á∂_É∆‡– ¿€~≤ﬁÛ>Ù†êÂÏø˘të/ˆåm–Ï ¸ıD¨ˇä—Ï{P»rˆﬂŒ~æfÖzπ*lHÙbÇöYüÏìòo˘Â¥_HΩ«‚ê @˙Hå∂`◊,‡˘ˇj6˚ow@(¸Ö4J@ HÖu∞ÓN>À„æZ¯{˚ì+C »›ˆi¡_ÃƒíÍué#k†∏˙ëÕ.E⁄~&nÈ{KPØ `q?9‚¥Oˇlˇ[€-ﬂC€œT#=ÙÕ Å	Î‚ÿ+{uﬂ-¬g9Îü´^Ç˙ : Fb\%æ◊ ∑ú˝5ªaˆ7’++'H–Êoû0-ÓuPËÙ£3±B€œ\#= £-∏3–˜˚ΩÚ˜W≈W|G—+ËuÄ+^ò“∂›—€n7Ω3@ÔXÓ∆;˙Â€M˙˛Z¯”?á `Ó d2˘¨t‘9WÄ¡Xå”ÇÀ„¬ñ[~O>=∫%¯Û“Qü%@#àB7ÃXó«Ö-Ø¯éÒöt\güÄ¢≤.û=ÚË≥Ÿü∂_tù[Å}@Á4˝Y∑≠v¸≈8ÂàOË<9ìd@€ÇπŸ|ÊIAtQ@#àJ€Çß3Jßi˚ç¶ëé ô∞>- v˜ÇM?câí`1⁄Ç!p÷Tù@Áç@Æ◊¯∂px4˙Bëwˇ˝Ioˆ];ôLét˘PÃåıùC–ˆÀKÄÃƒ8-ÿáæ◊è∂_~˙,802›¡wÙÀiﬁÌó∑Ë4¶… 2„¥`¥˝ÚEê©ß◊≈Ïü2ÄJ§“‰Õæy#»úfÎ‹ÙkÅ∂_z» *≥˘Ùx{Ói˚Âè† wøG^{=ÓLÃÏü&2Ä
=˛Àôƒˆ¬s6oB\}@+Hän¬âŸ‘∂ü˛ôHN+ıYº'úLNÃ∂ mødE9Äi[0F@€/iW§#ñ ŸúáÌÁ‚›~˜
í% t˛Cèe[ê7˚ñá PòÂã>,p⁄/y≠tƒ (G+ë ÂàR∏* R‘JG}¿%ê"∫ @≈ZÈ®s òL&≠Ä‰∏±˘æt‘w'  HKØ•yﬂ @ HK+=Ù ≠ HI+=Ù ÔÄîÃ•ñ @: K † ÆØË˛0Ìê iË=á\B  “@  *6J ∏( R–{,ˆ æË¿é@`\W˙ ’–KAY „4áÄÛ`LÉ∆‡– ¿é@`\„e nÌ1Í ¿Xt˝?®‚≈ s0ÜπD  Ú5∏" <' ∆0x/Œ‡ ‡œÃ@Ls=ﬂ °^: 1i¡á
 ,Ä∏^ñ Ç üäÃ@óB§ˇ*T†Ê ÜsH» î à!ÿI‹`Än ≈<T˙ØBf *Xj`W[PË †©	g ≠õ˝Év‹Ç øÿ ÊXË@±' ∞Òò< ¯ÎâÊ §†≈ø%ã@èT@Â∂ƒÄI Ö¥ Ñ‡≈ø%´@—¬òâÀ †ãñ 0åŸÏØÃÄo	í √Ãƒêe†Ù| Y –èÈÏØ>-Ü4∏vÌöf3A4Wˇ˚°†ÊÙDåπ p»}ºÁûC`]:˚c÷K j@?3â¿<XrôÄfç 8HîŸ_ôg + ÎòI$—2 Â≤ÄÓc* ˆ¢˜˝›*ëƒ S˜qA ÏÂà≈°üΩƒ\,œPv∑s´®Ä¢-Ï™uœ±ÿ j†|[ê„¬¿«Õb~=X¢ \ßó}ìå ˜Ò∂∞@›4#æuåŸ_E_,˘ø0K‘n6÷‡W£e K,P±—Rˇ•@#,PüVF®˙Ô4⁄`…ÿ&å⁄Ã∆¸jÙ †‹7bKÿ Ñzú≥æËc]£/ñ¸!]
4î´ïE’?âõ≤í	 äz 
7jÀo7I,ñ®†pI¨˚W% ı JˇSíò§ñ ´ÿÄÇåﬁÔﬂK Ä¢ J–J˝˛Ω$ EAdÆïÑøJ: (në≈-B‰F+˛ó$a…wÚﬂ@:»ÕFÍÉ_% îÔêãY*;˝íE PÓ +∆ê¸ŸsOæ∞ì´	ú“î’‡WŸ E@Ç≤¸*À †HHñÉ_e A 	»v´¨Ä"`DY~ï} På‡Täá{∫*" (6‹«≥ÿ“3˝ßrÈÛ§ò †¸∂·óÑD∞°ÉˇX;¸÷UT P˛ ëûhßïƒˆÙëÕN¿u˘êûΩû∆\ª +î‚Ä“îøÄa&¿0zÉÔ±T.Ò≠∏%¿NnIp }hóÄ„ƒË¢®bﬂ^ä ä∫ :j•¿ı˛nä\Ï‰ê∑
óç‚`˙;R‰z7Ud ´¸~]4‹PE øSu@˘%Ånö
∞®Úﬂ_À¨ø™ä%¿N+]Ωe®»Í.÷≤úı´XÔÔ¶ `Ÿ@µÊRÈ¨ø™ `’J6pø,™ø([ı≥˛™Í3ÄU>–·Ü†DZ·¨‘M=} v·Å*∫EPÇπ,ŒÓ_|LıKÄ›¯eÅÓ`Yê∑÷=w˚tü¡ø2Ä5∞w ;ö‚üÀ˝∂û ¯s	Å U€ﬂ=O±Œ_†#ˇ÷‚BFê~OÄXåÆï≈¿éÅﬂ  Ó6≈2™˙A ZŸG0≤Ç–tÜﬂ“«¸wA åê3óEöë4?<Ä1üLe—=`c—zÊ˛°®gå ë«e—Eò
VÕ˝£)˛˚Ç( #Y…é˚œ⁄Ó,‘ô}Ó™¯#! $¬Ñ;e±D8·?K:¿ıÖÁıì
~ âÚo9ZÖÂììK+œ≈íﬁ¶S@F|P¯º‹h3Í3f`∏"7fˆ÷jãÆ%•œ† .0hPhd±lX˝l¸Âê‹XR4¸Î⁄_/˘Í◊:»ˇG±                  Æˇ&…˝É¬1-ø    IENDÆB`Ç                                                                                                                                               UAWAVAUATWVSHÉÏXHç¨$Ä   É:LãmHHâÀDâ«DâŒÖ    LãbMÖ‰ÑΩ   Lâ·ËΩT Öˇu9∆å—   )˛9å˜   Iã4$H;5,' Ññ  Dãu@∂E1‰Lç=2# AÉŒÎeÄ    HçKAç|$Ë™ â|$0HçVEâÒLâl$(Hâ¡A∏   Lâ|$ Ë'ˆˇˇHã6Hâ¡HÖ¿ÑÑ   Ës Hâ√∂ <;Ñï   <,t<]u]Aâ¸<]uû∏   ÎÄ    Hã!ﬁ& ËT&  Hâ¡Ëî  1¿HÉƒX[^_A\A]A^A_]√êHç!1# Ë,&  Hâ¡Ël  1¿Î÷Ñ     HçR1# Ëƒ#  1¿ÎæHç1# Ë¸%  Hâ¡Ë<  1¿Î¶Ñ     ËãM Hâ«HÖ¿uÎÕêHçVHâ˘ËdX Hã6HÖˆuÏHçK∆Eƒ AÉƒLç}¿«GH   «E¿   Hâ}»ËÖ Dâd$0E1¿EâÒHâ¡Hç«0# Lâl$(Lâ˙HâD$ Ë˛ÙˇˇLâ˘Hâ√Ëì 1¿HÖ€ï¿ÈˇˇˇfD  Lâ·ËË–ˇˇIã4$ÈY˛ˇˇff.Ñ     @ UAVAUATWVSHâÂHÉÏ0Hç8≥) Hç§  Hç≥®  Lç5[0# Lç-\∞) Hç=≈±) ËpÚ π   HçÙ≤) A∏   fâÁ≤) Hç0∞) HâA¥) fDâA¥) H« ≤) üÜ «¥)    ∆¥) Ë Ú HçÈØ) Aπ   A∫  HçV±) H«œØ) üÜ Hâ,±) «±)    ∆±) fDâ±) fDâ£Ø) ËŒÒ Î@ ãSÔ∆CˇÖ“uP®u_HÉ√8H9ﬁtjLãcÁLâ·Ë‰-  HÉ¯ár  Lâ‚HâŸËü-  ∂C®uøâ¬É‚Ä˙“É‚˛É¬àSˇãSÔÖ“t∞Hâ⁄LâÈËíÙ ∂C®t°Hâ⁄Hâ˘HÉ√8Ë{Ù H9ﬁuñH«{§  "  Ëñ{ π   H«ÆÆ     H«€Æ      `z H«˚∑     HòHâ∑  ËMŒ¸ˇHçéØ  IâƒËû Lâ%áØ  «uØ     MÖ‰tAÉD$Lâ·ËÍÏ¸ˇËıJ Hçﬁ∞  Hâ√Ëf Hâ◊∞  «≈∞     HÖ€tÉCHπ   Ë‚Õ¸ˇHç[∂  IâƒË3 Lâ%T∂  «B∂     MÖ‰tAÉD$Lâ·ËÏ¸ˇH∏ˇˇˇˇˇˇˇ∆Eˇ"Hâä±  HÉ¿Hâ∑±  HãX	' H«ç∞      H«∫∞     ã H«Â∞     H«±     ÉËH«¨±  @   HòHâ;∂  Hã4®  H«9≤      H«f≤     H«ì≤     H«¿≤     H«Ì≤     H«≥     H«G≥     H«t≥     H«°≥     H«Œ≥  	   H«˚≥  
   HÖ¿tÄ8 t+Hç¢ß  Ë
 HçMˇ∫   «äß     ËÔ HâÜß  HÉƒ0[^_A\A]A^]√Ä    LâÒË‡  π   ËVf LãcÁÈs˝ˇˇff.Ñ     fêE1¿â HçîØ) Èoƒ˛ˇff.Ñ     @ E1¿â Hç¥¨) ÈOƒ˛ˇff.Ñ     @ UAVAUATWVSHâÂHÉÏ Lã%H' Aã$AâÕÖ“é€   1ˆE1¿ø   Ä    IãD$Lã40EÖ¿Ñé   AãÜx  Ö¿~Y1€ÎÄ    HÉ√A9ûx  ~AHâÿH¡‡IÜà  HÉ8 tﬂEÖ¿u⁄HãHE1¿E1…DâÍËÿπ˛ˇE1¿Ö¿Aï¿HÉ√A9ûx  øÉ«HÉ∆A9<$çyˇˇˇDâ¿HÉƒ [^_A\A]A^]√Ä    IãNE1¿DâÍHÉ¡(ËU√˛ˇE1¿Ö¿IãD$Aï¿Lã40ÈHˇˇˇE1¿Î∏fÑ     UAWAVAUATHâÂHÉÏ0IâœHçV¢  Iâ÷Mâ≈«E¸    MâÃË1 «7¢     MÖˇÑ^  Lâ˘ËÊÏ Hâ'¢  HçP¢  Ë «A¢     MÖˆÑ`  LâÒË∏Ï Hâ1¢  HçZ¢  Ë’ «K¢     MÖÌÑ"  LâÈËäÏ Hâ;¢  Hçd¢  Ëß «U¢     MÖ‰Ñ‰   Lâ·Ë\Ï HâE¢  HãÆ& E1…E1¿HçU¸HãËˇˇÖ¿t«E¸   Hçj°  ËU Hçñ°  «T°     H«Q°      Ë4 Hç≠°  «k°     H«h°      Ë Hçƒ°  «Ç°     H«°      ËÚ ãU¸1¿«õ°     H«ò°      Ö“î¿HÉƒ0A\A]A^A_]√D  H«Õ†      È°˛ˇˇH«e°      ÈˇˇˇH«°      È›˛ˇˇH«’†      Èü˛ˇˇUAUATHâÂHÉÏ0IâÃHçÍ†  «E¸    Iâ’Ë[ «—†     MÖ‰Ñ¿   Lâ·ËÎ Hâ¡†  Hçí°  Ë- «É°     MÖÌÑ™   LâÈË‚Í Hâs°  Hã¯& E1…E1¿HçU¸HãËíˇˇÖ¿t«E¸   Hç`†  Ë€ Hç4°  «J†     H«G†      Ë∫ ãU¸∏   «°     H«°      Ö“u9HÉƒ0A\A]]√Ä    H«†      È?ˇˇˇÑ     H«Õ†      ÈUˇˇˇLâ·Ëà(  1¿HÉƒ0A\A]]√ff.Ñ     êUAVAUATHÉÏ8Hç¨$Ä   IâŒHç£ü  Iâ’Mâƒ«E¨    Ë «áü     MÖˆÑˆ   LâÒË∆È Hâwü  Hçÿü  Ë„ «…ü     MÖÌÑ   LâÈËòÈ Hâπü  Hçrü  Ëµ «cü     MÖ‰Ñ≤   Lâ·ËjÈ HâSü  Hã¨Ô& HçU¨E1…E1¿HãËˇˇHçÛû  Ën HçWü  «›û     H«⁄û      ËM Hç˛û  «,ü     H«)ü      Ë, «⁄û     H«◊û      HÉƒ8A\A]A^]√ H«Öû      È	ˇˇˇÑ     H«•û      ÈMˇˇˇH«Õû      ÈˇˇˇUAVAUATHÉÏ8Hç¨$Ä   IâŒHç3û  Iâ’MâƒË® «û     MÖˆÑı   LâÒË]Ë Hâû  Hçßû  Ëz «òû     MÖÌÑÁ   LâÈË/Ë Hâàû  Hç	û  ËL «˙ù     MÖ‰Ñ©   Lâ·ËË HâÍù  Hã#ı& HçU¨E1…E1¿HãË±ˇˇHçäù  Ë Hç&û  «tù     H«qù      Ë‰ Hçïù  «˚ù     H«¯ù      Ë√ «qù     H«nù      HÉƒ8A\A]A^]√fêH«ù      È
ˇˇˇH«Eù      ÈVˇˇˇH«•ù      ÈˇˇˇUVSHâÂHÉÏ Hã1Hâ”HÖˆt+HçNË≤ HãHâHÖ…tHÉ¡Ën HÉƒ [^]√fD  ∏ˇˇˇˇÎÎfÑ     LçŸò  Hc…Iâ—HçÕ    H)»H¡‡Iç ÛoBAH«B    ãRÖ“t√Ä    IçT Hç•) ÈOÍ ff.Ñ     @ UHâÂHÉÏ Hc…Iâ–Hçkò  HçÕ    MãHH)»IãH¡‡HâLLâLÖ…tHÉƒ ]√ê// Copyright 2014 The Chromium Authors. All rights reserved.
// Use of this source code is governed by a BSD-style license that can be
// found in the LICENSE file.

#ifndef CLASS_REQUIRES_TRACE_METHOD_H_
#define CLASS_REQUIRES_TRACE_METHOD_H_

#include "heap/stubs.h"

namespace blink {

class HeapObject;

class PartObject {
    DISALLOW_NEW();
private:
    Member<HeapObject> m_obj;
};

class HeapObject : public GarbageCollected<HeapObject> {
private:
    PartObject m_part;
};

class Mixin : public GarbageCollectedMixin {
public:
  virtual void Trace(Visitor*) override;
  Member<Mixin> m_self;
};

class HeapObjectMixin : public GarbageCollected<HeapObjectMixin>, public Mixin {
  USING_GARBAGE_COLLECTED_MIXIN(HeapObjectMixin);
};

class Mixin2 : public Mixin {
public:
  virtual void Trace(Visitor*) override;
};

class HeapObjectMixin2
    : public GarbageCollected<HeapObjectMixin2>, public Mixin2 {
  USING_GARBAGE_COLLECTED_MIXIN(HeapObjectMixin2);
};

class Mixin3 : public Mixin {
public:
  virtual void Trace(Visitor*) override;
};

class HeapObjectMixin3
    : public GarbageCollected<HeapObjectMixin3>, public Mixin {
  USING_GARBAGE_COLLECTED_MIXIN(HeapObjectMixin2);
public:
  virtual void Trace(Visitor*) override;
};

}

#endif
                                                                                                                                                                                                                                   DX·Á>°5ŸÖ»>)l'oΩaá})ΩTzô§øÑ0O cÆøˆÆ	z√&g]µz◊ÈÁ4ﬁJ2™µµÜTúƒ?{7ôB:J’ê:»Úe√<|∞ZP:„°Ü/k¿„í	*∂5Q¬d•æëj¨§;5hÈÃä˝π{B¸Üπ¶«iÀ¸Ìˇê¨∆èÌ=+"W%Ù[πW_¿_c@≈Qá?Ìéxà‚?ñÏ≈Ï≥ŸâL^«±Ba"Àû¬îŒL&™=® i´—Z¡8]_Ka)v∫eU	àéÓ˚Ω/ÒFs˚#â@¸Æí9ÒO‹ﬁìÉ{≈ùöó†~Öæ∆K˛á¯∞
áÅ„M˛	ú>	)‚5ÊtJ2MÿEı©9ß #7±X.ÂŸ…NÈ◊‰
1_	OãU"µ·µ„∞∑H°[ü–.¥(Óe∆wªÕ‰°E¢¿f;6Õ˜bΩÚ1®ÎA˝Ÿp!öÖSÙˇ⁄˛Óø‘v< w»û‹ÚïYôqxÎùé⁄ûZÉ¨€¨¸n¶∆±´Rï6`âº´|/n£5êoñé,-∞ãDô:ëÎ‡CtÙcå˙¥\ıíèY3x5
á}Úâïı¢Á=?ÒônÜèÊÓ3ñÙ2˛¶Q+g^x	ì|¡û¨Op`ñWò¥∫Zíuˇ£Û˜È-?ª±Ä4< ±S∫«ıîo≈`µÆÒŒw a$(qÌÒﬂd·$ÿŒË®;ZÆÏ!/´]Gm˘ÍÑÈWßv‘ËFöUï˙Ï”≤∞=lÖRm‘ÂÒîè.PY ˇ¥~qQ∑	åó4¨Üåçg;ÈMj*pNV:€ó‘!ÜL`ÜúÛÀe-˝÷_-S(""7ù’Ê*Kπ8<£Æ4Im+4s[K˚⁄tOüáMm\Òó3ˇ0î∞ÎUπ'äw8#Î6=éyòﬂ	ôÆ#¥ë‘¡|˝ïà$éGQr*L∏+Bn_›gÈ¨*é˜kDﬁÔÎ∏[|Ùi7ƒÛGÙäFÅÇ
Ë—al´¬ﬂ}√¿ırWﬁûµÿµÙºÖ‚“îZ#S‡ñ∫FOJ,E±ÊFX¯”Õ‡\÷Åd‡Ô?ñ+¡\@$Peπ"QÕ¬Õÿ¢r!ÒôC†Í“`P®—'bﬂ!Ôí¥Óqh¥ΩG◊·{ï˚	{¨ò[ÀÅúKi ˛0|S÷l„ïv˙ËLOr\f‘…˚ÑF∆ÂﬁÙú|Õ≠~aÓY∏ÌÅ®–œˆo,TÎt'Ç>Äå≈p	frX†|∫ﬂªΩó,Ié“ˆ“JW˜∏ì5w£<a„E‰S∑˜© Z)»∏£å1ˇœgwÔft⁄ˆZNc_Ø.G™ú8öÁ≥N∑s~´vóG Zç·ˇº√ù¶lòÿ¬)œÿ†äæÕ´˜I∑ÃI|
‰ﬂvÍd	-MMÕöƒ≈U-˛“
t¯Ÿ,`Í÷S]∏ˇB¯+7eWÎ2¢O±€ÎREC(x∫Ñ_éôdÜÿD<‹@Ó‚æ∆\u;ÓãŸ.SuS¬†∞F$@À„`o_4WîtÙ„zH¥q|¶—8^∞Ω/|ÀsŸwöYÕv∏÷&ñKû-ïmR"À•ˆ≤¨ı˝∆˝+èñcÛÌ‹∑ÊrÒ°F=±‚3≠c6tõi“™QÀ|+ï Ö J≠$J4.bÜ^PXIO∆◊{'	˙
≈ƒ|Øˆ≈´:âπ
D≥ßÙä`§ÅÉËé'§&ÁFÉ›Z:•7⁄-ﬁ2Ë∆t¬ﬂLÀQAz$?c»-‚xLHˇÉ;«