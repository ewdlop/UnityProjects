"):
                    if cmds.objExists(character + ":" + "pinky_metacarpal_ctrl_r.buttonName"):
                        cmds.setAttr(character + ":" + "pinky_metacarpal_ctrl_r.buttonName",self.widgets[character + "_rightPinkyMetacarpalPickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "pinky_metacarpal_ctrl_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "pinky_metacarpal_ctrl_r.buttonName",self.widgets[character + "_rightPinkyMetacarpalPickerButton"], type = "string")
            except:
                pass



            try:
                if cmds.objExists(character + ":" + "pinky_finger_fk_ctrl_1_r"):
                    if cmds.objExists(character + ":" + "pinky_finger_fk_ctrl_1_r.buttonName"):
                        cmds.setAttr(character + ":" + "pinky_finger_fk_ctrl_1_r.buttonName",self.widgets[character + "_rightPinky1PickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "pinky_finger_fk_ctrl_1_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "pinky_finger_fk_ctrl_1_r.buttonName",self.widgets[character + "_rightPinky1PickerButton"], type = "string")
            except:
                pass



            try:
                if cmds.objExists(character + ":" + "pinky_finger_fk_ctrl_2_r"):
                    if cmds.objExists(character + ":" + "pinky_finger_fk_ctrl_2_r.buttonName"):
                        cmds.setAttr(character + ":" + "pinky_finger_fk_ctrl_2_r.buttonName",self.widgets[character + "_rightPinky2PickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "pinky_finger_fk_ctrl_2_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "pinky_finger_fk_ctrl_2_r.buttonName",self.widgets[character + "_rightPinky2PickerButton"], type = "string")
            except:
                pass


            try:
                if cmds.objExists(character + ":" + "pinky_finger_fk_ctrl_3_r"):
                    if cmds.objExists(character + ":" + "pinky_finger_fk_ctrl_3_r.buttonName"):
                        cmds.setAttr(character + ":" + "pinky_finger_fk_ctrl_3_r.buttonName",self.widgets[character + "_rightPinky3PickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "pinky_finger_fk_ctrl_3_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "pinky_finger_fk_ctrl_3_r.buttonName",self.widgets[character + "_rightPinky3PickerButton"], type = "string")
            except:
                pass




            #right ring finger
            try:
                if cmds.objExists(character + ":" + "ring_metacarpal_ctrl_r"):
                    if cmds.objExists(character + ":" + "ring_metacarpal_ctrl_r.buttonName"):
                        cmds.setAttr(character + ":" + "ring_metacarpal_ctrl_r.buttonName",self.widgets[character + "_rightRingMetacarpalPickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "ring_metacarpal_ctrl_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "ring_metacarpal_ctrl_r.buttonName",self.widgets[character + "_rightRingMetacarpalPickerButton"], type = "string")
            except:
                pass


            try:
                if cmds.objExists(character + ":" + "ring_finger_fk_ctrl_1_r"):
                    if cmds.objExists(character + ":" + "ring_finger_fk_ctrl_1_r.buttonName"):
                        cmds.setAttr(character + ":" + "ring_finger_fk_ctrl_1_r.buttonName",self.widgets[character + "_rightRing1PickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "ring_finger_fk_ctrl_1_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "ring_finger_fk_ctrl_1_r.buttonName",self.widgets[character + "_rightRing1PickerButton"], type = "string")
            except:
                pass



            try:
                if cmds.objExists(character + ":" + "ring_finger_fk_ctrl_2_r"):
                    if cmds.objExists(character + ":" + "ring_finger_fk_ctrl_2_r.buttonName"):
                        cmds.setAttr(character + ":" + "ring_finger_fk_ctrl_2_r.buttonName",self.widgets[character + "_rightRing2PickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "ring_finger_fk_ctrl_2_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "ring_finger_fk_ctrl_2_r.buttonName",self.widgets[character + "_rightRing2PickerButton"], type = "string")
            except:
                pass


            try:
                if cmds.objExists(character + ":" + "ring_finger_fk_ctrl_3_r"):
                    if cmds.objExists(character + ":" + "ring_finger_fk_ctrl_3_r.buttonName"):
                        cmds.setAttr(character + ":" + "ring_finger_fk_ctrl_3_r.buttonName",self.widgets[character + "_rightRing3PickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "ring_finger_fk_ctrl_3_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "ring_finger_fk_ctrl_3_r.buttonName",self.widgets[character + "_rightRing3PickerButton"], type = "string")
            except:
                pass


            #right middle finger
            try:
                if cmds.objExists(character + ":" + "middle_metacarpal_ctrl_r"):
                    if cmds.objExists(character + ":" + "middle_metacarpal_ctrl_r.buttonName"):
                        cmds.setAttr(character + ":" + "middle_metacarpal_ctrl_r.buttonName",self.widgets[character + "_rightMiddleMetacarpalPickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "middle_metacarpal_ctrl_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "middle_metacarpal_ctrl_r.buttonName",self.widgets[character + "_rightMiddleMetacarpalPickerButton"], type = "string")
            except:
                pass



            try:
                if cmds.objExists(character + ":" + "middle_finger_fk_ctrl_1_r"):
                    if cmds.objExists(character + ":" + "middle_finger_fk_ctrl_1_r.buttonName"):
                        cmds.setAttr(character + ":" + "middle_finger_fk_ctrl_1_r.buttonName",self.widgets[character + "_rightMiddle1PickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "middle_finger_fk_ctrl_1_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "middle_finger_fk_ctrl_1_r.buttonName",self.widgets[character + "_rightMiddle1PickerButton"], type = "string")
            except:
                pass


            try:
                if cmds.objExists(character + ":" + "middle_finger_fk_ctrl_2_r"):
                    if cmds.objExists(character + ":" + "middle_finger_fk_ctrl_2_r.buttonName"):
                        cmds.setAttr(character + ":" + "middle_finger_fk_ctrl_2_r.buttonName",self.widgets[character + "_rightMiddle2PickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "middle_finger_fk_ctrl_2_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "middle_finger_fk_ctrl_2_r.buttonName",self.widgets[character + "_rightMiddle2PickerButton"], type = "string")

            except:
                pass



            try:
                if cmds.objExists(character + ":" + "middle_finger_fk_ctrl_3_r"):
                    if cmds.objExists(character + ":" + "middle_finger_fk_ctrl_3_r.buttonName"):
                        cmds.setAttr(character + ":" + "middle_finger_fk_ctrl_3_r.buttonName",self.widgets[character + "_rightMiddle3PickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "middle_finger_fk_ctrl_3_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "middle_finger_fk_ctrl_3_r.buttonName",self.widgets[character + "_rightMiddle3PickerButton"], type = "string")
            except:
                pass



            #right index finger
            try:
                if cmds.objExists(character + ":" + "index_metacarpal_ctrl_r"):
                    if cmds.objExists(character + ":" + "index_metacarpal_ctrl_r.buttonName"):
                        cmds.setAttr(character + ":" + "index_metacarpal_ctrl_r.buttonName",self.widgets[character + "_rightIndexMetacarpalPickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "index_metacarpal_ctrl_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "index_metacarpal_ctrl_r.buttonName",self.widgets[character + "_rightIndexMetacarpalPickerButton"], type = "string")
            except:
                pass



            try:
                if cmds.objExists(character + ":" + "index_finger_fk_ctrl_1_r"):
                    if cmds.objExists(character + ":" + "index_finger_fk_ctrl_1_r.buttonName"):
                        cmds.setAttr(character + ":" + "index_finger_fk_ctrl_1_r.buttonName",self.widgets[character + "_rightIndex1PickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "index_finger_fk_ctrl_1_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "index_finger_fk_ctrl_1_r.buttonName",self.widgets[character + "_rightIndex1PickerButton"], type = "string")
            except:
                pass



            try:
                if cmds.objExists(character + ":" + "index_finger_fk_ctrl_2_r"):
                    if cmds.objExists(character + ":" + "index_finger_fk_ctrl_2_r.buttonName"):
                        cmds.setAttr(character + ":" + "index_finger_fk_ctrl_2_r.buttonName",self.widgets[character + "_rightIndex2PickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "index_finger_fk_ctrl_2_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "index_finger_fk_ctrl_2_r.buttonName",self.widgets[character + "_rightIndex2PickerButton"], type = "string")
            except:
                pass



            try:
                if cmds.objExists(character + ":" + "index_finger_fk_ctrl_3_r"):
                    if cmds.objExists(character + ":" + "index_finger_fk_ctrl_3_r.buttonName"):
                        cmds.setAttr(character + ":" + "index_finger_fk_ctrl_3_r.buttonName",self.widgets[character + "_rightIndex3PickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "index_finger_fk_ctrl_3_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "index_finger_fk_ctrl_3_r.buttonName",self.widgets[character + "_rightIndex3PickerButton"], type = "string")
            except:
                pass



            #right thumb finger
            try:
                if cmds.objExists(character + ":" + "thumb_finger_fk_ctrl_1_r"):
                    if cmds.objExists(character + ":" + "thumb_finger_fk_ctrl_1_r.buttonName"):
                        cmds.setAttr(character + ":" + "thumb_finger_fk_ctrl_1_r.buttonName",self.widgets[character + "_rightThumb1PickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "thumb_finger_fk_ctrl_1_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "thumb_finger_fk_ctrl_1_r.buttonName",self.widgets[character + "_rightThumb1PickerButton"], type = "string")
            except:
                pass


            try:
                if cmds.objExists(character + ":" + "thumb_finger_fk_ctrl_2_r"):
                    if cmds.objExists(character + ":" + "thumb_finger_fk_ctrl_2_r.buttonName"):
                        cmds.setAttr(character + ":" + "thumb_finger_fk_ctrl_2_r.buttonName",self.widgets[character + "_rightThumb2PickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "thumb_finger_fk_ctrl_2_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "thumb_finger_fk_ctrl_2_r.buttonName",self.widgets[character + "_rightThumb2PickerButton"], type = "string")
            except:
                pass


            try:
                if cmds.objExists(character + ":" + "thumb_finger_fk_ctrl_3_r"):
                    if cmds.objExists(character + ":" + "thumb_finger_fk_ctrl_3_r.buttonName"):
                        cmds.setAttr(character + ":" + "thumb_finger_fk_ctrl_3_r.buttonName",self.widgets[character + "_rightThumb3PickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "thumb_finger_fk_ctrl_3_r")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "thumb_finger_fk_ctrl_3_r.buttonName",self.widgets[character + "_rightThumb3PickerButton"], type = "string")
            except:
                pass




            #right IK fingers
            try:
                if cmds.objExists(character + ":" + "index_r_ik_anim"):
                    if cmds.objExists(character + ":" + "index_r_ik_anim.buttonName"):
                        cmds.setAttr(character + ":" + "index_r_ik_anim.buttonName",self.widgets[character + "_rightIndexFingerIKPickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "index_r_ik_anim")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "index_r_ik_anim.buttonName",self.widgets[character + "_rightIndexFingerIKPickerButton"], type = "string")
            except:
                pass


            try:
                if cmds.objExists(character + ":" + "middle_r_ik_anim"):
                    if cmds.objExists(character + ":" + "middle_r_ik_anim.buttonName"):
                        cmds.setAttr(character + ":" + "middle_r_ik_anim.buttonName",self.widgets[character + "_rightMiddleFingerIKPickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "middle_r_ik_anim")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "middle_r_ik_anim.buttonName",self.widgets[character + "_rightMiddleFingerIKPickerButton"], type = "string")
            except:
                pass


            try:
                if cmds.objExists(character + ":" + "ring_r_ik_anim"):
                    if cmds.objExists(character + ":" + "ring_r_ik_anim.buttonName"):
                        cmds.setAttr(character + ":" + "ring_r_ik_anim.buttonName",self.widgets[character + "_rightRingFingerIKPickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "ring_r_ik_anim")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "ring_r_ik_anim.buttonName",self.widgets[character + "_rightRingFingerIKPickerButton"], type = "string")
            except:
                pass



            try:
                if cmds.objExists(character + ":" + "pinky_r_ik_anim"):
                    if cmds.objExists(character + ":" + "pinky_r_ik_anim.buttonName"):
                        cmds.setAttr(character + ":" + "pinky_r_ik_anim.buttonName",self.widgets[character + "_rightPinkyFingerIKPickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "pinky_r_ik_anim")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "pinky_r_ik_anim.buttonName",self.widgets[character + "_rightPinkyFingerIKPickerButton"], type = "string")
            except:
                pass


            try:
                if cmds.objExists(character + ":" + "thumb_r_ik_anim"):
                    if cmds.objExists(character + ":" + "thumb_r_ik_anim.buttonName"):
                        cmds.setAttr(character + ":" + "thumb_r_ik_anim.buttonName",self.widgets[character + "_rightThumbFingerIKPickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "thumb_r_ik_anim")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "thumb_r_ik_anim.buttonName",self.widgets[character + "_rightThumbFingerIKPickerButton"], type = "string")
            except:
                pass



            #right IK finger PVs
            try:
                if cmds.objExists(character + ":" + "index_r_ik_anim"):
                    if cmds.objExists(character + ":" + "index_r_poleVector.buttonName"):
                        cmds.setAttr(character + ":" + "index_r_poleVector.buttonName",self.widgets[character + "_rightIndexIkPvPickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "index_r_poleVector")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "index_r_poleVector.buttonName",self.widgets[character + "_rightIndexIkPvPickerButton"], type = "string")
            except:
                pass


            try:        
                if cmds.objExists(character + ":" + "middle_r_ik_anim"):
                    if cmds.objExists(character + ":" + "middle_r_poleVector.buttonName"):
                        cmds.setAttr(character + ":" + "middle_r_poleVector.buttonName",self.widgets[character + "_rightMiddleIkPvPickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "middle_r_poleVector")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "middle_r_poleVector.buttonName",self.widgets[character + "_rightMiddleIkPvPickerButton"], type = "string")
            except:
                pass



            try:
                if cmds.objExists(character + ":" + "ring_r_ik_anim"):
                    if cmds.objExists(character + ":" + "ring_r_poleVector.buttonName"):
                        cmds.setAttr(character + ":" + "ring_r_poleVector.buttonName",self.widgets[character + "_rightRingIkPvPickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "ring_r_poleVector")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "ring_r_poleVector.buttonName",self.widgets[character + "_rightRingIkPvPickerButton"], type = "string")
            except:
                pass


            try:
                if cmds.objExists(character + ":" + "pinky_r_ik_anim"):
                    if cmds.objExists(character + ":" + "pinky_r_poleVector.buttonName"):
                        cmds.setAttr(character + ":" + "pinky_r_poleVector.buttonName",self.widgets[character + "_rightPinkyIkPvPickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "pinky_r_poleVector")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "pinky_r_poleVector.buttonName",self.widgets[character + "_rightPinkyIkPvPickerButton"], type = "string")
            except:
                pass


            try:
                if cmds.objExists(character + ":" + "thumb_r_ik_anim"):
                    if cmds.objExists(character + ":" + "thumb_r_poleVector.buttonName"):
                        cmds.setAttr(character + ":" + "thumb_r_poleVector.buttonName",self.widgets[character + "_rightThumbIkPvPickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "thumb_r_poleVector")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "thumb_r_poleVector.buttonName",self.widgets[character + "_rightThumbIkPvPickerButton"], type = "string")
            except:
                pass



            try:
                if cmds.objExists(character + ":" + "r_global_ik_anim"):
                    if cmds.objExists(character + ":" + "r_global_ik_anim.buttonName"):
                        cmds.setAttr(character + ":" + "r_global_ik_anim.buttonName",self.widgets[character + "_rightIkGlobalCtrlPickerButton"], type = "string")

                    else:
                        cmds.select(character + ":" + "r_global_ik_anim")
                        cmds.addAttr(ln = "buttonName", dt = "string", keyable = False)
                        cmds.setAttr(character + ":" + "r_global_ik_anim.buttonName",self.widgets[character + "_rightIkGlobalCtrlPickerButton"], type = "string")
            except:
                pass


                                                                                                                                                                                                                                                                                                                                                                                                                                   (Ω:ä˘U7Ó-ô\˜hNn◊Îƒ;Î]OëYê0GWÛ◊60ì6î-˚2dMõHÉı5â€	6Wdÿ-vç¡ÙÉ”˙*‚O˝k%ôë„aårtÎ}ù≥d¶˛£Ó+„±Ae{VŸn∑4)ä :Ñ©ÉÅœªAòoR"Z—@ü4ªFS‘M'z≥¡ä∫Ú˝º;)Í`|»›ë≈Ω∑Y¨oêˆ˛È„P©d'Ï;ü¢_	 Sﬂ≥Œµâ≈#ïÑCYzÆæÔ°ÛQr¿Äæ–ÍáÙIíZÚº“S	ãÅ} 2(˜oıÓ◊k≥©zWfhˆŒâº≠6‚˚$≠ö+),µÈ„ÏÔiôz[±ÈÚÇ0U=:≠ê√xcŸC%ÑÌô›f$dÀÅÀª+â‚.¬ß»˙|_ ∆˝O$J˝ˇÿgD»}@<gè¨ \Ió!q‡BV3€U\MR¢Êµ≤BjuH÷§ÉW,íÉH √g9u™ÆÇ°+Üœ¶·∞˘+å¿ªó∞Ÿµ≈˜^¬©ë£Õ√ÉÒQÇtº’o∆GRV´<c‘c°0èèÂ!çº
¡âßΩÀá'–∑”Ñ¥“ósCd≠Q'Ïà^¿Ò€;réïÓ˘.¬Fé:}{r«ÔºûQÎ	õÊ=8˜ÙI¬á≥=i÷‡ÑPN%“π›XˆÎµ»?√eHæQÚO
Ãfy∫W›˘]Èfwy£W/÷"V∞ı•=¥”àdﬁX‘G°Hú   E¶ñQ)¬g‘D@_Ú,MCxˇÎPﬂÏ> ®wÓ,
’cz<‡#Al3
¨I÷ ä´’>>J»WQlëH
ÿ>k∂¥,ﬂÛùP`: **!Àû“jÈÅä9!Vˆ∆¥?W"O@º§5†=u ¶¥9"wQ@˝√úØÃ¿¸NO√&X≥‚èª —Ç 5œÿkû÷º,±ÅÔ∆æ’Øj0ñÉÛ™€sŒÏ¯q;N≤UqÂiÜ\s‘ÔQRËÑÚà\˜—‰~ hßã ŒU˙jÚ7 ô{ m4Ãad°1QGΩÛ'	oÏ|1øh%rz≥ˆA…Ñ±ˇ˛øja9˚Õ'*Í»ÇFœH9 ¶ppú˚ÉµH≈Ñü~´pNÿøEDz˜Ê∏ê\ÑhÖ…Ùû·é˚Å≥çœôWÔX©∏≈öå¶Î˘ﬂ∏ÜyÙYì5:îö•Çs3ıå?¡RÀç4=}ø„›ò’˘;≤˝ç_∂Vv”“≥∂ä¶Ì÷jπºÏc™Ö„„¢ˆ∆ÕCO /ä£C{á∞^obò0ònM=eR®Ñq$s®‰Wﬂ›ôøÒIäO˛G$Ã•ü__x?õî–ËıV˙ù[œpZ°Â’¯ÙØ≈É]A8ZóaÂ4|§¡// Licensed to the .NET Foundation under one or more agreements.
// The .NET Foundation licenses this file to you under the MIT license.
// See the LICENSE file in the project root for more information.

using Microsoft.Win32.SafeHandles;
using System.Collections;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Runtime.InteropServices;
using System.Threading.Tasks;

namespace System.Net.Sockets
{
    internal static partial class SocketPal
    {
        public const bool SupportsMultipleConnectAttempts = false;
        private static readonly bool SupportsDualModeIPv4PacketInfo = GetPlatformSupportsDualModeIPv4PacketInfo();

        private static bool GetPlatformSupportsDualModeIPv4PacketInfo()
        {
            return Interop.Sys.PlatformSupportsDualModeIPv4PacketInfo();
        }

        public static void Initialize()
        {
            // nop.  No initialization required.
        }

        public static SocketError GetSocketErrorForErrorCode(Interop.Error errorCode)
        {
            return SocketErrorPal.GetSocketErrorForNativeError(errorCode);
        }

        public static void CheckDualModeReceiveSupport(Socket socket)
        {
            if (!SupportsDualModeIPv4PacketInfo && socket.AddressFamily == AddressFamily.InterNetworkV6 && socket.DualMode)
            {
                throw new PlatformNotSupportedException(SR.net_sockets_dualmode_receivefrom_notsupported);
            }
        }

        private static unsafe IPPacketInformation GetIPPacketInformation(Interop.Sys.MessageHeader* messageHeader, bool isIPv4, bool isIPv6)
        {
            if (!isIPv4 && !isIPv6)
            {
                return default(IPPacketInformation);
            }

            Interop.Sys.IPPacketInformation nativePacketInfo = default;
            if (!Interop.Sys.TryGetIPPacketInformation(messageHeader, isIPv4, &nativePacketInfo))
            {
                return default(IPPacketInformation);
            }

            return new IPPacketInformation(nativePacketInfo.Address.GetIPAddress(), nativePacketInfo.InterfaceIndex);
        }

        public static SocketError CreateSocket(AddressFamily addressFamily, SocketType socketType, ProtocolType protocolType, out SafeCloseSocket socket)
        {
            return SafeCloseSocket.CreateSocket(addressFamily, socketType, protocolType, out socket);
        }

        private static unsafe int Receive(SafeCloseSocket socket, SocketFlags flags, Span<byte> buffer, byte[] socketAddress, ref int socketAddressLen, out SocketFlags receivedFlags, out Interop.Error errno)
        {
            Debug.Assert(socketAddress != null || socketAddressLen == 0, $"Unexpected values: socketAddress={socketAddress}, socketAddressLen={socketAddressLen}");

            long received = 0;
            int sockAddrLen = socketAddress != null ? socketAddressLen : 0;

            fixed (byte* sockAddr = socketAddress)
            fixed (byte* b = &MemoryMarshal.GetReference(buffer))
            {
                var iov = new Interop.Sys.IOVector {
                    Base = b,
                    Count = (UIntPtr)buffer.Length
                };

                var messageHeader = new Interop.Sys.MessageHeader {
                    SocketAddress = sockAddr,
                    SocketAddressLen = sockAddrLen,
                    IOVectors = &iov,
                    IOVectorCount = 1
                };

                errno = Interop.Sys.ReceiveMessage(
                    socket.DangerousGetHandle(), // to minimize chances of handle recycling from misuse, this should use DangerousAddRef/Release, but it adds too much overhead
                    &messageHeader,
                    flags,
                    &received);
                GC.KeepAlive(socket); // small extra safe guard against handle getting collected/finalized while P/Invoke in progress

                receivedFlags = messageHeader.Flags;
                sockAddrLen = messageHeader.SocketAddressLen;
            }

            if (errno != Interop.Error.SUCCESS)
            {
                return -1;
            }

            socketAddressLen = sockAddrLen;
            return checked((int)received);
        }

        private static unsafe int Send(SafeCloseSocket socket, SocketFlags flags, ReadOnlySpan<byte> buffer, ref int offset, ref int count, byte[] socketAddress, int socketAddressLen, out Interop.Error errno)
        {
            int sent;
            fixed (byte* sockAddr = socketAddress)
            fixed (byte* b = &MemoryMarshal.GetReference(buffer))
            {
                var iov = new Interop.Sys.IOVector
                {
                    Base = &b[offset],
                    Count = (UIntPtr)count
                };

                var messageHeader = new Interop.Sys.MessageHeader
                {
                    SocketAddress = sockAddr,
                    SocketAddressLen = socketAddress != null ? socketAddressLen : 0,
                    IOVectors = &iov,
                    IOVectorCount = 1
                };

                long bytesSent = 0;
                errno = Interop.Sys.SendMessage(
                    socket.DangerousGetHandle(), // to minimize chances of handle recycling from misuse, this should use DangerousAddRef/Release, but it adds too much overhead
                    &messageHeader,
                    flags,
                    &bytesSent);
                GC.KeepAlive(socket); // small extra safe guard against handle getting collected/finalized while P/Invoke in progress

                sent = checked((int)bytesSent);
            }

            if (errno != Interop.Error.SUCCESS)
            {
                return -1;
            }

            offset += sent;
            count -= sent;
            return sent;
        }

        private static unsafe int Send(SafeCloseSocket socket, SocketFlags flags, IList<ArraySegment<byte>> buffers, ref int bufferIndex, ref int offset, byte[] socketAddress, int socketAddressLen, out Interop.Error errno)
        {
            // Pin buffers and set up iovecs.
            int startIndex = bufferIndex, startOffset = offset;

            int sockAddrLen = 0;
            if (socketAddress != null)
            {
                sockAddrLen = socketAddressLen;
            }

            int maxBuffers = buffers.Count - startIndex;
            var handles = new GCHandle[maxBuffers];
            var iovecs = new Interop.Sys.IOVector[maxBuffers];

            int sent;
            int toSend = 0, iovCount = maxBuffers;
            try
            {
                for (int i = 0; i < maxBuffers; i++, startOffset = 0)
                {
                    ArraySegment<byte> buffer = buffers[startIndex + i];
                    RangeValidationHelpers.ValidateSegment(buffer);

                    handles[i] = GCHandle.Alloc(buffer.Array, GCHandleType.Pinned);
                    iovecs[i].Base = &((byte*)handles[i].AddrOfPinnedObject())[buffer.Offset + startOffs